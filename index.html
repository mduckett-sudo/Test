<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Department Portal (No CDN) • Supabase via fetch()</title>
  <style>
    :root{
      --bg:#0b1220;
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --shadow:0 18px 48px rgba(0,0,0,.45);
      --radius:18px; --radius2:14px;

      --good:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --info:#7aa7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(122,167,255,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(46,229,157,.14), transparent 55%),
        radial-gradient(900px 600px at 75% 90%, rgba(255,92,122,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    button,input,select,textarea{font:inherit;color:inherit}
    .center{min-height:100vh; display:grid; place-items:center; padding:22px}
    .card{
      width:min(560px, 100%);
      padding:18px;
      border-radius:22px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 30px 90px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
    }
    .row{display:flex;gap:12px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%),
        linear-gradient(135deg, rgba(122,167,255,.85), rgba(46,229,157,.85));
      border:1px solid rgba(255,255,255,.18);
    }
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .field{display:flex; flex-direction:column; gap:6px; margin-top:10px}
    .field label{font-size:12px; color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:10px; outline:none; font-size:13px;
    }
    .btn{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.045);
      cursor:pointer;
      display:inline-flex; gap:10px; align-items:center;
    }
    .btn.primary{border-color:rgba(46,229,157,.32); background:rgba(46,229,157,.12)}
    .btn.danger{border-color:rgba(255,92,122,.34); background:rgba(255,92,122,.12)}
    .err{margin-top:10px; color:rgba(255,92,122,.95); font-size:12px}
    .ok{margin-top:10px; color:rgba(46,229,157,.95); font-size:12px}
    .badge{
      font-size:12px; padding:3px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.good{border-color:rgba(46,229,157,.35); background:rgba(46,229,157,.10); color:rgba(46,229,157,.95)}
    .badge.info{border-color:rgba(122,167,255,.35); background:rgba(122,167,255,.10); color:rgba(122,167,255,.95)}
    .badge.warn{border-color:rgba(255,204,102,.35); background:rgba(255,204,102,.10); color:rgba(255,204,102,.95)}
    .badge.bad{border-color:rgba(255,92,122,.35); background:rgba(255,92,122,.10); color:rgba(255,92,122,.95)}

    /* App */
    .shell{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .sidebar{
      position:sticky; top:0; height:100vh;
      padding:22px;
      border-right:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
    }
    .nav{margin-top:14px; display:flex; flex-direction:column; gap:8px}
    .nav .item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid transparent;
      color:var(--muted); cursor:pointer; user-select:none;
    }
    .nav .item:hover{background:rgba(255,255,255,.05); color:var(--text)}
    .nav .item.active{
      background:rgba(122,167,255,.12);
      border-color:rgba(122,167,255,.25);
      color:var(--text);
    }
    .pill{
      margin-left:auto; font-size:12px; padding:3px 9px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--muted);
    }
    .main{padding:22px 26px 36px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px; border-radius:18px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);
      flex-wrap:wrap;
    }
    .panel{
      margin-top:14px;
      border-radius:18px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 18px 48px rgba(0,0,0,.24);
      overflow:hidden;
    }
    .panelHead{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      flex-wrap:wrap;
    }
    .panelBody{padding:14px}
    pre{white-space:pre-wrap; margin:0; font-size:12px; color:rgba(255,255,255,.78)}
    @media (max-width: 980px){ .shell{grid-template-columns:1fr} .sidebar{position:relative;height:auto} }
  </style>
</head>

<body>
<!-- Small status banner -->
<div id="status" style="position:fixed;top:12px;left:12px;z-index:9999;
padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.18);
background:rgba(0,0,0,.35);color:white;font:12px system-ui;backdrop-filter:blur(8px);">
No-CDN build • ready
</div>

<section id="loginView" class="center">
  <div class="card">
    <div class="row">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div style="font-weight:800; letter-spacing:.2px;">Department Portal</div>
        <div class="hint">No external JS CDN • Supabase via <code>fetch()</code></div>
      </div>
      <span class="badge info" style="margin-left:auto;">Works on restrictive networks</span>
    </div>

    <div class="panel" style="margin-top:14px;">
      <div class="panelHead">
        <div>
          <div style="font-weight:800;">Sign in</div>
          <div class="hint">Uses Supabase Auth REST endpoints (GoTrue) + PostgREST.</div>
        </div>
        <span class="badge" id="keyBadge">Keys: set</span>
      </div>
      <div class="panelBody">
        <form id="loginForm">
          <div class="field">
            <label>Email</label>
            <input id="email" type="email" placeholder="you@department.org" required />
          </div>
          <div class="field">
            <label>Password</label>
            <input id="password" type="password" placeholder="••••••••" required />
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
            <button class="btn primary" type="submit">Sign in</button>
            <button class="btn" type="button" id="signUpBtn">Create account</button>
          </div>

          <div id="loginErr" class="err" style="display:none;"></div>
          <div id="loginOk" class="ok" style="display:none;"></div>

          <div class="hint" style="margin-top:10px;">
            If “Create account” says email confirmation required, you can disable it in Supabase Auth settings (or confirm emails).
          </div>
        </form>
      </div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div style="font-weight:700;">Troubleshooting</div>
        <span class="badge warn">Read me</span>
      </div>
      <div class="panelBody">
        <div class="hint">
          This version avoids loading <b>supabase-js</b> from a CDN (your network was blocking it).
          If login still fails, the error message will show exactly why (bad password, email not confirmed, missing profile row, or RLS).
        </div>
      </div>
    </div>

  </div>
</section>

<section id="appView" style="display:none;">
  <div class="shell">
    <aside class="sidebar">
      <div class="row" style="padding:12px;border-radius:16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div style="font-weight:800; font-size:14px;">Department Portal</div>
          <div class="hint">Role-based access (RLS)</div>
        </div>
      </div>

      <div style="margin-top:14px;padding:14px;border-radius:18px;background:rgba(255,255,255,.045);border:1px solid rgba(255,255,255,.12);">
        <div style="font-weight:700;font-size:13px;">Active Profile</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
          <span class="badge info" id="whoLine">Loading…</span>
          <span class="badge" id="stationLine">Station</span>
          <span class="badge" id="shiftLine">Shift</span>
        </div>
      </div>

      <nav class="nav" id="nav">
        <div class="item active" data-page="home"><span>Home</span><span class="pill">Me</span></div>
        <div class="item" data-page="debug"><span>Debug</span><span class="pill">JSON</span></div>
      </nav>

      <div style="margin-top:14px;">
        <button class="btn danger" id="logoutBtn">Log out</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div style="font-weight:800;">Welcome</div>
          <div class="hint" id="welcomeLine">Loading…</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn" id="refreshBtn">Refresh</button>
        </div>
      </div>

      <section id="page-home">
        <div class="panel">
          <div class="panelHead">
            <div style="font-weight:800;">Quick status</div>
            <span class="badge" id="accessBadge">—</span>
          </div>
          <div class="panelBody" id="homeBody">
            <div class="hint">Loading…</div>
          </div>
        </div>
      </section>

      <section id="page-debug" style="display:none;">
        <div class="panel">
          <div class="panelHead">
            <div style="font-weight:800;">Session + Profile</div>
            <span class="badge">Debug</span>
          </div>
          <div class="panelBody">
            <div style="display:grid;gap:10px;">
              <div class="panel" style="margin:0;">
                <div class="panelHead"><div style="font-weight:700;">Session</div></div>
                <div class="panelBody"><pre id="sessionDump"></pre></div>
              </div>
              <div class="panel" style="margin:0;">
                <div class="panelHead"><div style="font-weight:700;">Profile</div></div>
                <div class="panelBody"><pre id="profileDump"></pre></div>
              </div>
              <div class="panel" style="margin:0;">
                <div class="panelHead"><div style="font-weight:700;">Candidate (linked)</div></div>
                <div class="panelBody"><pre id="candidateDump"></pre></div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>
</section>

<script>
  /***********************************************************************
   * ✅ SET THESE TWO VALUES (Supabase → Project Settings → API)
   **********************************************************************/
  const SUPABASE_URL = "https://xjaihdmbblieyzkltvmm.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqYWloZG1iYmxpZXl6a2x0dm1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTY3MzcsImV4cCI6MjA4Njg3MjczN30.eR8C_ororBpLxSXfuLM8Q6fKvKQnCVRcZnNEH2pM4jA";
  /**********************************************************************/

  const $ = (id) => document.getElementById(id);
  const show = (el) => el.style.display = "";
  const hide = (el) => el.style.display = "none";
  const setText = (id, text) => { const el = $(id); if (el) el.textContent = text; };
  const status = (msg) => { const el = $("status"); if (el) el.textContent = msg; };

  function keysMissing(){
    return !SUPABASE_URL || !SUPABASE_ANON_KEY ||
      SUPABASE_URL.includes("PASTE_") || SUPABASE_ANON_KEY.includes("PASTE_");
  }

  // Simple token storage
  const TOKEN_KEY = "dept_portal_tokens_v1";

  function saveTokens(t){ localStorage.setItem(TOKEN_KEY, JSON.stringify(t)); }
  function loadTokens(){ try{ return JSON.parse(localStorage.getItem(TOKEN_KEY) || "null"); }catch{ return null; } }
  function clearTokens(){ localStorage.removeItem(TOKEN_KEY); }

  function authHeaders(accessToken){
    return {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + accessToken
    };
  }

  async function authSignIn(email, password){
    const url = `${SUPABASE_URL}/auth/v1/token?grant_type=password`;
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "apikey": SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ email, password })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json?.error_description || json?.msg || json?.message || "Sign-in failed");
    return json; // includes access_token, refresh_token, user, etc.
  }

  async function authSignUp(email, password){
    const url = `${SUPABASE_URL}/auth/v1/signup`;
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "apikey": SUPABASE_ANON_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ email, password })
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json?.error_description || json?.msg || json?.message || "Sign-up failed");
    return json;
  }

  async function authGetUser(accessToken){
    const url = `${SUPABASE_URL}/auth/v1/user`;
    const res = await fetch(url, { headers: authHeaders(accessToken) });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json?.error_description || json?.msg || json?.message || "Could not fetch user");
    return json;
  }

  async function restGet(path, accessToken){
    const url = `${SUPABASE_URL}/rest/v1/${path}`;
    const res = await fetch(url, { headers: { ...authHeaders(accessToken), "Accept":"application/json" } });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json?.message || "REST GET failed");
    return json;
  }

  async function restPatch(path, accessToken, body){
    const url = `${SUPABASE_URL}/rest/v1/${path}`;
    const res = await fetch(url, {
      method:"PATCH",
      headers: { ...authHeaders(accessToken), "Content-Type":"application/json", "Prefer":"return=representation" },
      body: JSON.stringify(body)
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(json?.message || "REST PATCH failed");
    return json;
  }

  // UI: nav pages
  const pages = ["home","debug"];
  const navItems = Array.from(document.querySelectorAll("#nav .item"));
  function switchPage(page){
    navItems.forEach(i => i.classList.toggle("active", i.dataset.page === page));
    pages.forEach(p => {
      const el = document.getElementById("page-" + p);
      if (el) el.style.display = (p === page) ? "" : "none";
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  navItems.forEach(item => item.addEventListener("click", () => switchPage(item.dataset.page)));

  // State
  let tokens = null;
  let user = null;
  let profile = null;
  let candidate = null;

  function showErr(msg){ $("loginErr").style.display=""; $("loginErr").textContent = msg; }
  function showOk(msg){ $("loginOk").style.display=""; $("loginOk").textContent = msg; }

  async function refreshAll(){
    $("loginErr").style.display="none";
    $("loginOk").style.display="none";

    tokens = loadTokens();
    if (!tokens?.access_token){
      hide($("appView")); show($("loginView"));
      status("Signed out");
      return;
    }

    status("Fetching user…");
    user = await authGetUser(tokens.access_token);

    status("Loading profile…");
    // profiles row must exist, id = auth.users.id
    const profs = await restGet(`profiles?select=*&id=eq.${encodeURIComponent(user.id)}&limit=1`, tokens.access_token);
    profile = Array.isArray(profs) ? profs[0] : null;

    if (!profile){
      clearTokens();
      hide($("appView")); show($("loginView"));
      showErr("Signed in, but no matching profiles row exists for this user ID. Create profiles row with id = auth.users.id.");
      status("Profile missing");
      return;
    }

    status("Loading linked candidate…");
    const cands = await restGet(`candidates?select=*&linked_user_id=eq.${encodeURIComponent(user.id)}&limit=1`, tokens.access_token);
    candidate = Array.isArray(cands) ? cands[0] : null;

    // Paint UI
    setText("whoLine", `${profile.full_name ?? "User"} • ${profile.role ?? "—"}`);
    setText("stationLine", String(profile.station ?? "Station —"));
    setText("shiftLine", String(profile.shift ?? "Shift —"));
    setText("welcomeLine", `${profile.full_name ?? "User"} (${profile.role ?? "—"})`);
    setText("accessBadge", candidate ? "Linked candidate: Yes" : "Linked candidate: No");

    $("sessionDump").textContent = JSON.stringify({ user_id:user.id, email:user.email }, null, 2);
    $("profileDump").textContent = JSON.stringify(profile, null, 2);
    $("candidateDump").textContent = JSON.stringify(candidate, null, 2);

    $("homeBody").innerHTML = `
      <div class="hint" style="margin-bottom:10px;">
        This “no-CDN” build proves your network can talk to Supabase without loading external libraries.
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <span class="badge info">Auth OK</span>
        <span class="badge ${profile ? "good":"bad"}">Profile ${profile ? "OK":"Missing"}</span>
        <span class="badge ${candidate ? "good":"warn"}">Candidate ${candidate ? "Linked":"Not linked"}</span>
      </div>
      <div class="hint" style="margin-top:12px;">
        Next step: once this works, we swap your full portal UI over to this same fetch()-based client.
      </div>
    `;

    hide($("loginView")); show($("appView"));
    switchPage("home");
    status("Ready");
  }

  $("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    $("loginErr").style.display="none";
    $("loginOk").style.display="none";

    if (keysMissing()){
      $("keyBadge").textContent = "Keys: MISSING";
      $("keyBadge").className = "badge bad";
      return showErr("Set SUPABASE_URL and SUPABASE_ANON_KEY in this file.");
    }

    const email = $("email").value.trim();
    const password = $("password").value;

    try{
      status("Signing in…");
      const t = await authSignIn(email, password);
      saveTokens({ access_token:t.access_token, refresh_token:t.refresh_token, token_type:t.token_type, expires_in:t.expires_in });
      showOk("Signed in. Loading portal…");
      await refreshAll();
    }catch(err){
      status("Sign-in error");
      showErr(err.message || String(err));
    }
  });

  $("signUpBtn").addEventListener("click", async () => {
    $("loginErr").style.display="none";
    $("loginOk").style.display="none";

    if (keysMissing()){
      $("keyBadge").textContent = "Keys: MISSING";
      $("keyBadge").className = "badge bad";
      return showErr("Set SUPABASE_URL and SUPABASE_ANON_KEY in this file.");
    }

    const email = $("email").value.trim();
    const password = $("password").value;

    try{
      status("Creating account…");
      await authSignUp(email, password);
      showOk("Account created. If confirmation is enabled, check email. Otherwise, sign in now.");
      status("Ready");
    }catch(err){
      status("Sign-up error");
      showErr(err.message || String(err));
    }
  });

  $("logoutBtn").addEventListener("click", async () => {
    clearTokens();
    await refreshAll();
  });

  $("refreshBtn").addEventListener("click", async () => {
    try{ await refreshAll(); }catch(e){ showErr(e.message || String(e)); }
  });

  // Init
  if (keysMissing()){
    $("keyBadge").textContent = "Keys: MISSING";
    $("keyBadge").className = "badge bad";
    status("Keys missing");
  } else {
    $("keyBadge").textContent = "Keys: set";
    status("Keys set");
  }

  // Auto resume session if tokens exist
  refreshAll().catch(e => showErr(e.message || String(e)));
</script>

</body>
</html>
