<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Briaroaks Department Portal</title>
  <style>
    :root{
      --bg:#07070a;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(0,0,0,.22);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --shadow:0 18px 48px rgba(0,0,0,.55);
      --radius:18px; --radius2:14px;

      --red:#ff2b2b;
      --blue:#2b6bff;

      --good:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --info:#7aa7ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      /* ‚úÖ Default: light grey ‚Üí dark grey ‚Üí black */
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.16), transparent 60%),
        radial-gradient(900px 600px at 80% 25%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(900px 600px at 70% 90%, rgba(255,255,255,.05), transparent 60%),
        linear-gradient(180deg, #cfcfd2 0%, #3b3b42 45%, #07070a 100%);
      color:var(--text);
      overflow-x:hidden;
    }

    /* ‚úÖ Training Manager overrides ONLY (fire / ems) */
    body.mode-training-fire{
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(255,43,43,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,43,43,.10), transparent 55%),
        radial-gradient(900px 600px at 75% 90%, rgba(255,43,43,.08), transparent 60%),
        var(--bg);
    }
    body.mode-training-ems{
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(43,107,255,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(43,107,255,.10), transparent 55%),
        radial-gradient(900px 600px at 75% 90%, rgba(43,107,255,.08), transparent 60%),
        var(--bg);
    }

    button,input,select,textarea{font:inherit;color:inherit}
    a{color:inherit}

    .shell{display:grid;grid-template-columns:300px 1fr;min-height:100vh}
    .sidebar{
      position:sticky; top:0; height:100vh;
      padding:22px;
      border-right:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      padding:12px; border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    .logoWrap{
      width:48px;height:48px;border-radius:14px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      display:grid;place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logoWrap img{width:40px;height:40px;object-fit:contain;display:block}

    .userBox{min-width:0}
    .userName{
      margin:0;
      font-size:14px;
      letter-spacing:.25px;
      font-weight:900;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .userLevels{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .badgesRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .badge{
      font-size:12px; padding:4px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      color:var(--muted);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .badge.fireInstr{
      border-color:rgba(255,43,43,.45);
      background:rgba(255,43,43,.14);
      color:rgba(255,255,255,.92);
    }
    .badge.emsInstr{
      border-color:rgba(43,107,255,.45);
      background:rgba(43,107,255,.14);
      color:rgba(255,255,255,.92);
    }
    /* ‚úÖ Admin: grey background + glowing rainbow border */
    .badge.adminGlow{
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      border:1px solid transparent;
      position:relative;
      box-shadow:0 0 18px rgba(255,255,255,.10);
    }
    .badge.adminGlow::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:999px;
      padding:2px;
      background:conic-gradient(
        #ff2b2b, #ffcc66, #2ee59d, #2b6bff, #b56cff, #ff2b2b
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      filter:blur(.2px);
      opacity:.95;
      pointer-events:none;
    }

    .nav{margin-top:16px; display:flex; flex-direction:column; gap:8px}
    .nav .item{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid transparent;
      color:var(--muted);
      cursor:pointer; user-select:none;
    }
    .nav .item:hover{background:rgba(255,255,255,.06); color:var(--text)}
    .nav .item.active{
      background:rgba(255,255,255,.10);
      border-color:rgba(255,255,255,.18);
      color:var(--text);
    }
    .ico{
      width:22px; height:22px;
      display:grid; place-items:center;
      border-radius:10px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
      font-size:14px;
    }
    .pill{
      margin-left:auto;
      font-size:12px; padding:3px 9px; border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--muted);
    }

    .main{padding:22px 26px 36px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px; border-radius:var(--radius);
      background:rgba(255,255,255,.07);
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      flex-wrap:wrap;
    }
    .search{
      flex:1; min-width:220px;
      display:flex; gap:10px; align-items:center;
      padding:10px 12px; border-radius:14px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
    }
    .search input{width:100%; border:0; outline:0; background:transparent; font-size:14px}
    .search input::placeholder{color:rgba(255,255,255,.42)}
    .rightTools{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .btn{
      padding:10px 12px; border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text); cursor:pointer; user-select:none;
      display:inline-flex; gap:10px; align-items:center;
      transition:transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{background:rgba(255,255,255,.09); border-color:rgba(255,255,255,.20)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:rgba(255,255,255,.22); background:rgba(255,255,255,.10)}
    .btn.danger{border-color:rgba(255,92,122,.34); background:rgba(255,92,122,.12)}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px}
    .btn.warn{border-color:rgba(255,204,102,.34); background:rgba(255,204,102,.10)}

    .pageHead{
      margin:18px 4px 14px;
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .pageHead h2{margin:0; font-size:18px; letter-spacing:.2px}
    .pageHead p{margin:6px 0 0 0; font-size:13px; color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    .stats{display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:12px; margin:14px 0 12px}
    .stat{
      padding:14px; border-radius:var(--radius);
      background:rgba(255,255,255,.07);
      border:1px solid var(--stroke);
      box-shadow:0 14px 38px rgba(0,0,0,.24);
      min-height:92px;
    }
    .stat .k{font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:10px}
    .stat .v{margin-top:10px; font-size:18px; font-weight:900; letter-spacing:.2px}

    .panel{
      border-radius:var(--radius);
      background:rgba(255,255,255,.07);
      border:1px solid var(--stroke);
      box-shadow:0 18px 48px rgba(0,0,0,.24);
      overflow:hidden;
    }
    .panelHead{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      flex-wrap:wrap;
    }
    .panelHead h3{margin:0; font-size:13px; letter-spacing:.25px}
    .panelHead .small{font-size:12px; color:var(--muted)}
    .panelBody{padding:14px}

    .card{
      padding:12px; border-radius:var(--radius2);
      background:rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .card h4{margin:0; font-size:13px; letter-spacing:.2px}
    .card p{margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.45}

    .table{width:100%; border-collapse:collapse}
    .table th,.table td{
      text-align:left; padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:13px; vertical-align:top;
    }
    .table th{
      font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.25px;
      background:rgba(0,0,0,.12);
    }
    .row:hover td{background:rgba(255,255,255,.04)}

    .miniBtn{
      padding:7px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      cursor:pointer; color:var(--text); font-size:12px;
    }
    .miniBtn:hover{background:rgba(255,255,255,.09)}

    .needs{display:flex; flex-wrap:wrap; gap:6px}
    .tag{
      font-size:12px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      white-space:nowrap;
    }
    .tag.good{border-color:rgba(46,229,157,.30); background:rgba(46,229,157,.10); color:rgba(46,229,157,.95)}
    .tag.warn{border-color:rgba(255,204,102,.28); background:rgba(255,204,102,.10); color:rgba(255,204,102,.95)}
    .tag.bad{border-color:rgba(255,92,122,.30); background:rgba(255,92,122,.10); color:rgba(255,92,122,.95)}
    .tag.info{border-color:rgba(122,167,255,.30); background:rgba(122,167,255,.10); color:rgba(122,167,255,.95)}

    .progressWrap{display:flex; gap:10px; align-items:center; min-width:170px}
    .bar{flex:1; height:8px; border-radius:999px; background:rgba(255,255,255,.12); overflow:hidden; border:1px solid rgba(255,255,255,.12)}
    .fill{height:100%; border-radius:999px; background:linear-gradient(90deg, rgba(255,255,255,.85), rgba(255,255,255,.35)); width:0%}
    .pct{font-size:12px; color:var(--muted); white-space:nowrap}

    /* Login */
    .center{min-height:100vh; display:grid; place-items:center; padding:22px}
    .loginCard{
      width:min(560px, 100%);
      padding:18px;
      border-radius:22px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 30px 90px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
    }
    .field{display:flex; flex-direction:column; gap:6px; margin-top:10px}
    .field label{font-size:12px; color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:10px; outline:none; font-size:13px;
    }
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .err{margin-top:10px; color:rgba(255,92,122,.95); font-size:12px; white-space:pre-wrap}
    .ok{margin-top:10px; color:rgba(46,229,157,.95); font-size:12px; white-space:pre-wrap}

    /* Modal */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:18px; z-index:50}
    .overlay.show{display:flex}
    .modal{
      width:min(980px, 100%);
      border-radius:22px;
      background:rgba(15,15,18,.82);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 30px 90px rgba(0,0,0,.6);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modalHead{
      display:flex; justify-content:space-between; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      align-items:center;
      flex-wrap:wrap;
    }
    .modalHead h3{margin:0; font-size:14px}
    .modalBody{display:grid; grid-template-columns:1fr 360px; min-height:380px}
    .rubric{padding:16px; border-right:1px solid rgba(255,255,255,.10)}
    .sideForm{padding:16px; display:flex; flex-direction:column; gap:12px}
    textarea{min-height:120px; resize:vertical}

    @media (max-width: 980px){
      .shell{grid-template-columns:1fr}
      .sidebar{position:relative; height:auto}
      .stats{grid-template-columns:repeat(2, minmax(0,1fr))}
      .modalBody{grid-template-columns:1fr}
      .rubric{border-right:0; border-bottom:1px solid rgba(255,255,255,.10)}
    }
    @media (max-width: 520px){
      .stats{grid-template-columns:1fr}
      .search{width:100%}
      .rightTools{width:100%; justify-content:space-between}
    }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <section id="loginView" class="center">
    <noscript>
      <div style="max-width:560px;margin:12px auto 0 auto;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,204,102,.35);background:rgba(255,204,102,.10);color:rgba(255,204,102,.95);font-size:12px;line-height:1.45;">
        JavaScript is disabled or blocked. This portal requires JavaScript.
      </div>
    </noscript>

    <div class="loginCard">
      <div style="display:flex;gap:12px;align-items:center;">
        <div class="logoWrap" aria-hidden="true">
          <img src="./logo.png" alt="Briaroaks logo" onerror="this.style.display='none'">
        </div>
        <div>
          <div style="font-weight:900; letter-spacing:.2px; font-size:16px;">Briaroaks Department Portal</div>
          <div class="hint">No external JS CDN ‚Ä¢ Supabase via fetch()</div>
        </div>
        <span class="badge" style="margin-left:auto;">iPad-friendly</span>
      </div>

      <div class="card" style="margin-top:14px;">
        <h4>Sign in</h4>
        <p>Uses Supabase Auth REST + PostgREST.</p>
      </div>

      <form id="loginForm">
        <div class="field">
          <label>Email</label>
          <input id="email" type="email" placeholder="you@department.org" required />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
          <button class="btn primary" type="submit">Sign in</button>
          <button class="btn" type="button" id="signUpBtn">Create account</button>
          <button class="btn" type="button" id="clearSessionBtn" title="Clears local session storage">Clear session</button>
        </div>

        <div id="loginErr" class="err" style="display:none;"></div>
        <div id="loginOk" class="ok" style="display:none;"></div>

        <div class="hint" style="margin-top:10px;">
          Tip: You can also create users in Supabase ‚Üí Authentication ‚Üí Users.
        </div>
      </form>
    </div>
  </section>

  <!-- APP -->
  <section id="appView" style="display:none;">
    <div class="shell">
      <aside class="sidebar">
        <!-- ‚úÖ New user header -->
        <div class="brand">
          <div class="logoWrap" aria-hidden="true">
            <img src="./logo.png" alt="Briaroaks logo" onerror="this.style.display='none'">
          </div>
          <div class="userBox">
            <div class="userName" id="sbName">Loading‚Ä¶</div>
            <div class="userLevels" id="sbLevels">‚Äî</div>
            <div class="badgesRow" id="sbBadges"></div>
          </div>
        </div>

        <!-- ‚úÖ Tabs under user header -->
        <nav class="nav" id="nav">
          <div class="item active" data-page="home">
            <span class="ico">üè†</span><span>Dashboard Home</span><span class="pill">Home</span>
          </div>
          <div class="item" data-page="training">
            <span class="ico">‚úÖ</span><span>My Training</span><span class="pill">My</span>
          </div>
          <div class="item" data-page="deptPersonnel">
            <span class="ico">üë•</span><span>Department Personnel</span>
          </div>
          <div class="item" data-page="trainingManager">
            <span class="ico">üß™</span><span>Training Manager</span><span class="pill">Staff</span>
          </div>
          <div class="item" data-page="personnelManager">
            <span class="ico">üßë‚Äçüíº</span><span>Personnel Manager</span><span class="pill">Officer</span>
          </div>
          <div class="item" data-page="settings">
            <span class="ico">‚öôÔ∏è</span><span>Settings</span>
          </div>
        </nav>
      </aside>

      <main class="main">
        <div class="topbar">
          <div class="search" role="search">
            <span style="opacity:.8;">üîé</span>
            <input placeholder="Search (visual only) ‚Ä¶" />
          </div>
          <div class="rightTools">
            <button class="btn" id="refreshBtn" type="button">Refresh</button>
            <button class="btn danger" id="logoutBtn" type="button">Log out</button>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="page-home">
          <div class="pageHead">
            <div>
              <h2>Dashboard Home</h2>
              <p>Quick snapshot: Weather ‚Ä¢ Fire rank ‚Ä¢ EMS level ‚Ä¢ EMS expiration.</p>
            </div>
            <div class="actions">
              <button class="btn primary" id="goTrainingBtn" type="button">Open My Training</button>
            </div>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k"><span>Weather</span><span class="badge" id="weatherZip">76028</span></div>
              <div class="v" id="dashWeather">Loading‚Ä¶</div>
              <div style="margin-top:8px; color:var(--muted); font-size:12px;" id="dashWeatherSub">Using Open-Meteo (no API key).</div>
            </div>

            <div class="stat">
              <div class="k"><span>Fire Rank</span><span class="badge info">Profile</span></div>
              <div class="v" id="dashFireRank">‚Äî</div>
              <div style="margin-top:8px; color:var(--muted); font-size:12px;" id="dashStation">Station ‚Äî</div>
            </div>

            <div class="stat">
              <div class="k"><span>EMS Level</span><span class="badge info">Profile</span></div>
              <div class="v" id="dashEmsLevel">‚Äî</div>
              <div style="margin-top:8px; color:var(--muted); font-size:12px;" id="dashAO">AO ‚Äî</div>
            </div>

            <div class="stat">
              <div class="k"><span>EMS Expiration</span><span class="badge warn">Countdown</span></div>
              <div class="v" id="dashEmsExpiry">Not set</div>
              <div style="margin-top:8px; color:var(--muted); font-size:12px;" id="dashEmsExpirySub">Ask an officer/admin to add it.</div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>What‚Äôs next</h3>
                <div class="small">Your requirements and progress live under ‚ÄúMy Training‚Äù.</div>
              </div>
              <button class="btn small primary" id="dashTrainingTile" type="button">Go</button>
            </div>
            <div class="panelBody">
              <div class="card">
                <h4>Keep it simple</h4>
                <p>Dashboard stays lightweight so it loads fast on iPads and station Wi-Fi.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- MY TRAINING -->
        <section id="page-training" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>My Training</h2>
              <p>Your requirements, progress, and status updates.</p>
            </div>
            <div class="actions">
              <button class="btn" id="refreshTrainingBtn" type="button">Refresh</button>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Requirements</h3>
                <div class="small">From <code>candidate_requirements</code> joined to <code>requirements</code>.</div>
              </div>
              <span class="badge" id="trainingCount">‚Äî</span>
            </div>
            <div class="panelBody" id="trainingTableWrap"></div>
          </div>
        </section>

        <!-- DEPARTMENT PERSONNEL (all users can see) -->
        <section id="page-deptPersonnel" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>Department Personnel</h2>
              <p>Roster: station, EMS, Fire, AO, and access badges.</p>
            </div>
            <div class="actions">
              <button class="btn" id="refreshDeptBtn" type="button">Refresh</button>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Members</h3>
                <div class="small">Read-only roster (RLS enforced).</div>
              </div>
              <span class="badge" id="membersCount">‚Äî</span>
            </div>
            <div class="panelBody" id="membersWrap"><div class="hint">Loading‚Ä¶</div></div>
          </div>
        </section>

        <!-- TRAINING MANAGER -->
        <section id="page-trainingManager" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>Training Manager</h2>
              <p>Pick Fire or EMS training. Theme changes only while you‚Äôre on this page.</p>
            </div>
            <div class="actions">
              <button class="btn warn" id="tmFireBtn" type="button">Fire Training</button>
              <button class="btn warn" id="tmEmsBtn" type="button">EMS Training</button>
              <button class="btn" id="refreshTMBtn" type="button">Refresh</button>
              <button class="btn primary" id="openEvalBtn" type="button">Start Evaluation</button>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Candidate Queue</h3>
                <div class="small">Shows candidates your account is allowed to see (RLS).</div>
              </div>
              <span class="badge" id="queueCount">‚Äî</span>
            </div>
            <div id="queueWrap"></div>
          </div>
        </section>

        <!-- PERSONNEL MANAGER (Officer/Admin) -->
        <section id="page-personnelManager" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>Personnel Manager</h2>
              <p>Officer/Admin can update station/levels/AO/expiration. Admin can update instructor flags + admin role.</p>
            </div>
            <div class="actions">
              <button class="btn" id="refreshPMBtn" type="button">Refresh</button>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Members</h3>
                <div class="small">Edit profiles (RLS enforced).</div>
              </div>
              <span class="badge" id="pmCount">‚Äî</span>
            </div>
            <div class="panelBody" id="pmWrap"></div>
          </div>
        </section>

        <!-- SETTINGS / DEBUG -->
        <section id="page-settings" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>Settings</h2>
              <p>Debug session + profile.</p>
            </div>
          </div>
          <div class="panel">
            <div class="panelHead">
              <h3>Debug</h3>
              <span class="badge">Useful</span>
            </div>
            <div class="panelBody">
              <div class="card">
                <h4>Session</h4>
                <pre id="sessionDump" style="white-space:pre-wrap;margin:0;color:rgba(255,255,255,.78);font-size:12px;"></pre>
              </div>
              <div class="card">
                <h4>Profile (raw)</h4>
                <pre id="profileDump" style="white-space:pre-wrap;margin:0;color:rgba(255,255,255,.78);font-size:12px;"></pre>
              </div>
              <div class="card">
                <h4>Last error</h4>
                <pre id="lastErrorDump" style="white-space:pre-wrap;margin:0;color:rgba(255,255,255,.78);font-size:12px;"></pre>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </section>

  <!-- EVALUATION MODAL -->
  <div id="overlayEval" class="overlay" role="dialog" aria-modal="true" aria-label="Evaluation Modal">
    <div class="modal">
      <div class="modalHead">
        <h3>Submit Evaluation</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="badge">Writes to DB</span>
          <button class="btn" id="closeEvalBtn" type="button">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="rubric">
          <div class="card">
            <h4>How this works</h4>
            <p>
              On submit, we create a row in <code>evaluations</code> and update the matching row in
              <code>candidate_requirements</code>.
            </p>
          </div>
          <div class="card">
            <h4>Rubric (placeholder)</h4>
            <p>Later we can build real rubrics per skill station.</p>
            <div class="needs" style="margin-top:10px;">
              <span class="tag info">Scene safety / PPE</span>
              <span class="tag">Primary assessment</span>
              <span class="tag warn">Critical steps</span>
              <span class="tag">Reassessment</span>
            </div>
          </div>
        </div>

        <div class="sideForm">
          <div class="field">
            <label>Candidate</label>
            <select id="evalCandidate"></select>
          </div>

          <div class="field">
            <label>Requirement</label>
            <select id="evalRequirement"></select>
          </div>

          <div class="field">
            <label>Result (req_status)</label>
            <select id="evalResult">
              <option value="Passed">Passed</option>
              <option value="Retake">Retake</option>
              <option value="Failed">Failed</option>
            </select>
          </div>

          <div class="field">
            <label>Critical Fail</label>
            <select id="evalCritical">
              <option value="false">No</option>
              <option value="true">Yes ‚Äî Critical Fail</option>
            </select>
          </div>

          <div class="field">
            <label>Notes</label>
            <textarea id="evalNotes" placeholder="Remediation notes / strengths / follow-up."></textarea>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="submitEvalBtn" type="button">Submit</button>
          </div>

          <div id="evalErr" class="err" style="display:none;"></div>
          <div id="evalOk" class="ok" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PERSONNEL MODAL -->
  <div id="overlayPM" class="overlay" role="dialog" aria-modal="true" aria-label="Personnel Modal">
    <div class="modal">
      <div class="modalHead">
        <h3>Edit Member</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="badge">Updates profiles</span>
          <button class="btn" id="closePMBtn" type="button">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="rubric">
          <div class="card">
            <h4>Editing rules</h4>
            <p>
              Officer can edit station/levels/AO + EMS expiration.
              Admin can also edit admin role and instructor flags.
            </p>
          </div>
          <div class="card">
            <h4>Selected member</h4>
            <p id="pmSelected">‚Äî</p>
            <div class="needs" style="margin-top:10px;">
              <span class="tag info" id="pmIdTag">ID: ‚Äî</span>
            </div>
          </div>
        </div>

        <div class="sideForm">
          <div class="field">
            <label>Station (station enum)</label>
            <select id="pmStation">
              <option value="173">Station 173</option>
              <option value="273">Station 273</option>
            </select>
          </div>

          <div class="field">
            <label>EMS Level (ems_level enum)</label>
            <select id="pmEms"></select>
          </div>

          <div class="field">
            <label>Fire Rank (fire_level enum)</label>
            <select id="pmFire"></select>
          </div>

          <div class="field">
            <label>AO Level (ao_level enum)</label>
            <select id="pmAO"></select>
          </div>

          <div class="field">
            <label>EMS Expiration (optional column: ems_expiration)</label>
            <input id="pmEmsExp" type="date" />
            <div class="hint">If your profiles table doesn‚Äôt have <code>ems_expiration</code>, save will ignore it.</div>
          </div>

          <div id="adminOnlyBlock" style="display:none;">
            <div class="card">
              <h4>Admin-only access</h4>
              <p>Change admin role and instructor flags.</p>
            </div>

            <div class="field">
              <label>Admin Role (admin_role enum)</label>
              <select id="pmAdminRole">
                <option value="None">None</option>
                <option value="Admin">Admin</option>
                <option value="Fire Chief">Fire Chief</option>
              </select>
            </div>

            <div class="field">
              <label>EMS Instructor</label>
              <select id="pmIsEmsInstr">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>

            <div class="field">
              <label>Fire Instructor</label>
              <select id="pmIsFireInstr">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="savePMBtn" type="button">Save</button>
          </div>

          <div id="pmErr" class="err" style="display:none;"></div>
          <div id="pmOk" class="ok" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/***********************************************************************
 * ‚úÖ SET THESE TWO VALUES (Supabase ‚Üí Project Settings ‚Üí API)
 **********************************************************************/
const SUPABASE_URL = "https://xjaihdmbblieyzkltvmm.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqYWloZG1iYmxpZXl6a2x0dm1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTY3MzcsImV4cCI6MjA4Njg3MjczN30.eR8C_ororBpLxSXfuLM8Q6fKvKQnCVRcZnNEH2pM4jA";
/**********************************************************************/

// ---------------- Helpers ----------------
const $ = (id) => document.getElementById(id);
const show = (el) => (el.style.display = "");
const hide = (el) => (el.style.display = "none");
const setText = (id, text) => { const el = $(id); if (el) el.textContent = text ?? ""; };
const esc = (s)=> (s??"").toString()
  .replaceAll("&","&amp;")
  .replaceAll("<","&lt;")
  .replaceAll(">","&gt;")
  .replaceAll('"',"&quot;")
  .replaceAll("'","&#039;");

function keysMissing() {
  return !SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("PASTE_");
}
function setLastError(msg){
  console.log("ERROR:", msg);
  const el = $("lastErrorDump");
  if (el) el.textContent = String(msg ?? "");
}

// ---------------- Supabase REST (no CDN) ----------------
const AUTH_URL = () => `${SUPABASE_URL}/auth/v1`;
const REST_URL = () => `${SUPABASE_URL}/rest/v1`;

let session = null;           // { access_token, refresh_token, user }
let currentProfile = null;
let currentCandidate = null;

let access = { admin:false, officer:false, instructor:false, emsInstr:false, fireInstr:false };

// Training Manager theme mode ONLY
let tmMode = "fire"; // fire | ems

function baseHeaders(){
  return {
    "apikey": SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
  };
}
function authHeaders(){
  const token = session?.access_token;
  return token
    ? { ...baseHeaders(), "Authorization": `Bearer ${token}` }
    : baseHeaders();
}

async function fetchJson(url, options={}){
  const res = await fetch(url, options);
  const text = await res.text();
  let json = null;
  try { json = text ? JSON.parse(text) : null; } catch { json = null; }

  if (!res.ok) {
    const msg = json?.msg || json?.message || text || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return json;
}

async function signIn(email, password){
  const url = `${AUTH_URL()}/token?grant_type=password`;
  return await fetchJson(url, {
    method:"POST",
    headers: { ...baseHeaders(), "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
    body: JSON.stringify({ email, password })
  });
}
async function signUp(email, password){
  const url = `${AUTH_URL()}/signup`;
  return await fetchJson(url, {
    method:"POST",
    headers: { ...baseHeaders(), "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
    body: JSON.stringify({ email, password })
  });
}
async function refreshToken(refresh_token){
  const url = `${AUTH_URL()}/token?grant_type=refresh_token`;
  return await fetchJson(url, {
    method:"POST",
    headers: { ...baseHeaders(), "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
    body: JSON.stringify({ refresh_token })
  });
}
function signOut(){
  clearSession();
}

async function restSelect(table, select, filters={}, opts={}){
  const query = new URLSearchParams();
  query.set("select", select);

  Object.entries(filters).forEach(([k,v])=>{
    if (v===undefined || v===null || v==="") return;
    query.set(k, v);
  });
  if (opts.order) query.set("order", opts.order);
  if (opts.limit) query.set("limit", String(opts.limit));

  const url = `${REST_URL()}/${table}?${query.toString()}`;
  return await fetchJson(url, { headers: authHeaders() });
}
async function restInsert(table, rows){
  const url = `${REST_URL()}/${table}`;
  return await fetchJson(url, {
    method:"POST",
    headers: { ...authHeaders(), "Prefer":"return=representation" },
    body: JSON.stringify(rows)
  });
}
async function restPatch(table, patchObj, filters){
  const query = new URLSearchParams();
  Object.entries(filters||{}).forEach(([k,v])=> query.set(k, v));
  const url = `${REST_URL()}/${table}?${query.toString()}`;
  return await fetchJson(url, {
    method:"PATCH",
    headers: { ...authHeaders(), "Prefer":"return=representation" },
    body: JSON.stringify(patchObj)
  });
}

// ---------------- Access model (schema correct) ----------------
function computeAccess(profile){
  const adminRole = String(profile?.admin_role ?? "").trim();
  const admin = (adminRole === "Admin" || adminRole === "Fire Chief");

  const emsInstr = !!profile?.is_ems_instructor || admin;
  const fireInstr = !!profile?.is_fire_instructor || admin;

  // "Instructor" means either flag
  const instructor = emsInstr || fireInstr;

  // You do not currently have an Officer field.
  // Treat Admin as Officer-level for now (matches your current behavior).
  const officer = admin;

  return { admin, officer, instructor, emsInstr, fireInstr };
}

// ---------------- Navigation + page switching ----------------
const loginView = $("loginView");
const appView = $("appView");

// NOTE: page ids correspond to section ids: page-<name>
const pages = ["home","training","deptPersonnel","trainingManager","personnelManager","settings"];
const navItems = Array.from(document.querySelectorAll("#nav .item"));

let currentPage = "home";

function applyTrainingThemeIfNeeded(){
  // Only apply fire/ems theme inside Training Manager
  document.body.classList.remove("mode-training-fire", "mode-training-ems");
  if (currentPage === "trainingManager"){
    document.body.classList.add(tmMode === "ems" ? "mode-training-ems" : "mode-training-fire");
  }
}

function switchPage(page){
  currentPage = page;
  navItems.forEach(i => i.classList.toggle("active", i.dataset.page === page));
  pages.forEach(p => {
    const el = document.getElementById("page-" + p);
    if (el) el.style.display = (p === page) ? "" : "none";
  });
  applyTrainingThemeIfNeeded();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

navItems.forEach(item => item.addEventListener("click", () => switchPage(item.dataset.page)));

function gateNav(){
  const tm = navItems.find(x => x.dataset.page === "trainingManager");
  const pm = navItems.find(x => x.dataset.page === "personnelManager");

  // Requested:
  // Training Manager if Instructor OR Officer OR Admin
  // Personnel Manager if Officer OR Admin
  if (tm) tm.style.display = (access.instructor || access.officer || access.admin) ? "" : "none";
  if (pm) pm.style.display = (access.officer || access.admin) ? "" : "none";
}

// ---------------- Sidebar header population ----------------
function renderSidebarHeader(profile){
  setText("sbName", profile?.full_name ?? "‚Äî");
  setText("sbLevels", `${String(profile?.ems_level ?? "‚Äî")} - ${String(profile?.fire_level ?? "‚Äî")}`);

  const badges = [];
  if (access.fireInstr) badges.push(`<span class="badge fireInstr">Fire Instructor</span>`);
  if (access.emsInstr)  badges.push(`<span class="badge emsInstr">EMS Instructor</span>`);
  if (access.admin)     badges.push(`<span class="badge adminGlow">Admin</span>`);

  $("sbBadges").innerHTML = badges.join("");
}

// ---------------- Session persistence ----------------
const SESSION_KEY = "briaroaks_portal_session_v1";
function saveSession(s){
  session = s;
  localStorage.setItem(SESSION_KEY, JSON.stringify(s));
}
function loadSession(){
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    session = raw ? JSON.parse(raw) : null;
  } catch { session = null; }
  return session;
}
function clearSession(){
  session = null;
  localStorage.removeItem(SESSION_KEY);
}

// ---------------- Weather (zip 76028) ----------------
// Uses Open-Meteo (no key): zip -> lat/lon -> current weather
async function loadWeatherForZip(zip="76028"){
  try{
    setText("dashWeather", "Loading‚Ä¶");
    setText("dashWeatherSub", "Using Open-Meteo (no API key).");

    // 1) Geocode by postal code (US)
    const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(zip)}&count=1&language=en&format=json`;
    const geo = await fetchJson(geoUrl, { method:"GET" });
    const hit = geo?.results?.[0];
    if (!hit) throw new Error("Could not find location for ZIP " + zip);

    const lat = hit.latitude;
    const lon = hit.longitude;
    const place = [hit.name, hit.admin1, hit.country_code].filter(Boolean).join(", ");

    // 2) Current weather
    const wxUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph`;
    const wx = await fetchJson(wxUrl, { method:"GET" });
    const c = wx?.current;
    if (!c) throw new Error("Weather unavailable.");

    const desc = weatherCodeToText(c.weather_code);
    const temp = Math.round(c.temperature_2m);
    const wind = Math.round(c.wind_speed_10m);

    setText("dashWeather", `${temp}¬∞F ‚Ä¢ ${desc}`);
    setText("dashWeatherSub", `${place} ‚Ä¢ Wind ${wind} mph`);
  }catch(err){
    setText("dashWeather", "Weather unavailable");
    setText("dashWeatherSub", err.message);
    setLastError(err.message);
  }
}

function weatherCodeToText(code){
  const map = {
    0:"Clear",
    1:"Mainly clear",
    2:"Partly cloudy",
    3:"Overcast",
    45:"Fog",
    48:"Depositing rime fog",
    51:"Light drizzle",
    53:"Drizzle",
    55:"Dense drizzle",
    56:"Freezing drizzle",
    57:"Freezing drizzle",
    61:"Light rain",
    63:"Rain",
    65:"Heavy rain",
    66:"Freezing rain",
    67:"Freezing rain",
    71:"Light snow",
    73:"Snow",
    75:"Heavy snow",
    77:"Snow grains",
    80:"Rain showers",
    81:"Rain showers",
    82:"Violent rain showers",
    85:"Snow showers",
    86:"Heavy snow showers",
    95:"Thunderstorm",
    96:"Thunderstorm + hail",
    99:"Thunderstorm + heavy hail"
  };
  return map[code] ?? `Code ${code}`;
}

// ---------------- UI wiring ----------------
$("clearSessionBtn")?.addEventListener("click", () => {
  clearSession();
  $("loginOk").style.display = "";
  $("loginOk").textContent = "Session cleared. You can sign in fresh now.";
});

$("loginForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  $("loginErr").style.display = "none";
  $("loginOk").style.display = "none";
  setLastError("");

  if (keysMissing()) {
    $("loginErr").style.display = "";
    $("loginErr").textContent = "Missing key: set SUPABASE_ANON_KEY at the top of the file.";
    return;
  }

  const email = $("email").value.trim();
  const password = $("password").value;

  try{
    const s = await signIn(email, password);
    saveSession(s);
    $("loginOk").style.display = "";
    $("loginOk").textContent = "Signed in. Loading portal‚Ä¶";
    await refreshAll();
  }catch(err){
    $("loginErr").style.display = "";
    $("loginErr").textContent = err.message;
    setLastError(err.message);
  }
});

$("signUpBtn")?.addEventListener("click", async () => {
  $("loginErr").style.display = "none";
  $("loginOk").style.display = "none";
  setLastError("");

  const email = $("email").value.trim();
  const password = $("password").value;

  try{
    await signUp(email, password);
    $("loginOk").style.display = "";
    $("loginOk").textContent = "Account created. If confirmation is enabled, check your email. Otherwise sign in now.";
  }catch(err){
    $("loginErr").style.display = "";
    $("loginErr").textContent = err.message;
    setLastError(err.message);
  }
});

$("logoutBtn")?.addEventListener("click", () => {
  signOut();
  currentProfile = null;
  currentCandidate = null;
  hide(appView);
  show(loginView);
});

$("refreshBtn")?.addEventListener("click", () => refreshAll());
$("refreshTrainingBtn")?.addEventListener("click", () => loadTraining());
$("refreshDeptBtn")?.addEventListener("click", () => loadMembers());
$("refreshTMBtn")?.addEventListener("click", () => loadQueue());
$("refreshPMBtn")?.addEventListener("click", () => loadPersonnel());

$("goTrainingBtn")?.addEventListener("click", () => switchPage("training"));
$("dashTrainingTile")?.addEventListener("click", () => switchPage("training"));

$("tmFireBtn")?.addEventListener("click", () => { tmMode = "fire"; applyTrainingThemeIfNeeded(); });
$("tmEmsBtn")?.addEventListener("click", () => { tmMode = "ems"; applyTrainingThemeIfNeeded(); });

// ---------------- Evaluation modal ----------------
const overlayEval = $("overlayEval");
$("closeEvalBtn")?.addEventListener("click", () => overlayEval.classList.remove("show"));
overlayEval?.addEventListener("click", (e) => { if (e.target === overlayEval) overlayEval.classList.remove("show"); });

$("openEvalBtn")?.addEventListener("click", async () => {
  $("evalErr").style.display = "none";
  $("evalOk").style.display = "none";
  overlayEval.classList.add("show");
  await populateEvalModal();
});

$("submitEvalBtn")?.addEventListener("click", async () => {
  $("evalErr").style.display = "none";
  $("evalOk").style.display = "none";
  setLastError("");

  const candidateId = $("evalCandidate").value;
  const requirementId = $("evalRequirement").value;
  const result = $("evalResult").value;
  const criticalFail = $("evalCritical").value === "true";
  const notes = $("evalNotes").value;

  if (!candidateId || !requirementId) {
    $("evalErr").style.display = "";
    $("evalErr").textContent = "Choose a candidate and a requirement.";
    return;
  }

  try{
    await restInsert("evaluations", [{
      candidate_id: candidateId,
      requirement_id: requirementId,
      evaluator_id: session.user.id,
      result,
      critical_fail: criticalFail,
      notes
    }]);

    await restPatch("candidate_requirements",
      { status: result, updated_at: new Date().toISOString() },
      { candidate_id: `eq.${candidateId}`, requirement_id: `eq.${requirementId}` }
    );

    $("evalOk").style.display = "";
    $("evalOk").textContent = "Saved. Requirement updated to: " + result;
    await refreshAll();
  }catch(err){
    $("evalErr").style.display = "";
    $("evalErr").textContent = err.message;
    setLastError(err.message);
  }
});

async function populateEvalModal(){
  try{
    const cands = await restSelect("candidates", "id,full_name,station,status,created_at", {}, { order:"created_at.desc" });
    const candSel = $("evalCandidate");
    candSel.innerHTML = "";
    (cands||[]).forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = `${c.full_name} ‚Ä¢ Station ${c.station ?? ""} ‚Ä¢ ${c.status ?? ""}`;
      candSel.appendChild(opt);
    });

    const reqs = await restSelect("requirements", "id,name,category,is_critical,created_at", {}, { order:"created_at.desc" });
    const reqSel = $("evalRequirement");
    reqSel.innerHTML = "";
    (reqs||[]).forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = `${r.name} ‚Ä¢ ${r.category ?? ""}${r.is_critical ? " ‚Ä¢ CRITICAL" : ""}`;
      reqSel.appendChild(opt);
    });

    if (currentCandidate?.id) candSel.value = currentCandidate.id;
  }catch(err){
    $("evalErr").style.display = "";
    $("evalErr").textContent = err.message;
    setLastError(err.message);
  }
}

// ---------------- Personnel modal ----------------
const overlayPM = $("overlayPM");
$("closePMBtn")?.addEventListener("click", () => overlayPM.classList.remove("show"));
overlayPM?.addEventListener("click", (e) => { if (e.target === overlayPM) overlayPM.classList.remove("show"); });

const EMS_LEVELS  = ["None","ECA","EMT-B","Paramedic"];
const AO_LEVELS   = ["None","AO-EMS","AO-1","AO-2"];
const FIRE_LEVELS = ["None","Level 5","Level 4","Level 3","Level 2","Level 1","Lieutenant","Captain","Deputy Chief","Assistant Chief","Fire Chief"];

function fillSelect(id, values){
  const sel = $(id);
  if (!sel) return;
  sel.innerHTML = "";
  values.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}
fillSelect("pmEms", EMS_LEVELS);
fillSelect("pmAO", AO_LEVELS);
fillSelect("pmFire", FIRE_LEVELS);

let editingMember = null;

async function openPersonnelModal(member){
  editingMember = member;
  $("pmErr").style.display = "none";
  $("pmOk").style.display = "none";
  setLastError("");

  $("pmSelected").textContent = `${member.full_name ?? "‚Äî"}`;
  $("pmIdTag").textContent = `ID: ${member.id}`;

  $("pmStation").value = String(member.station ?? "173");
  $("pmEms").value = String(member.ems_level ?? "None");
  $("pmFire").value = String(member.fire_level ?? "None");
  $("pmAO").value = String(member.ao_level ?? "None");

  const exp = member.ems_expiration ? String(member.ems_expiration).slice(0,10) : "";
  $("pmEmsExp").value = exp;

  $("adminOnlyBlock").style.display = access.admin ? "" : "none";
  if (access.admin){
    $("pmAdminRole").value = String(member.admin_role ?? "None");
    $("pmIsEmsInstr").value = String(!!member.is_ems_instructor);
    $("pmIsFireInstr").value = String(!!member.is_fire_instructor);
  }

  overlayPM.classList.add("show");
}

$("savePMBtn")?.addEventListener("click", async () => {
  $("pmErr").style.display = "none";
  $("pmOk").style.display = "none";
  setLastError("");

  if (!editingMember?.id){
    $("pmErr").style.display = "";
    $("pmErr").textContent = "No member selected.";
    return;
  }

  const patch = {
    station: $("pmStation").value,
    ems_level: $("pmEms").value,
    fire_level: $("pmFire").value,
    ao_level: $("pmAO").value,
  };

  const exp = $("pmEmsExp").value;
  patch.ems_expiration = exp ? exp : null;

  if (access.admin){
    patch.admin_role = $("pmAdminRole").value;
    patch.is_ems_instructor = ($("pmIsEmsInstr").value === "true");
    patch.is_fire_instructor = ($("pmIsFireInstr").value === "true");
  }

  try{
    await restPatch("profiles", patch, { id: `eq.${editingMember.id}` });
    $("pmOk").style.display = "";
    $("pmOk").textContent = "Saved.";
    await refreshAll();
    await loadPersonnel();
  }catch(err){
    $("pmErr").style.display = "";
    $("pmErr").textContent = err.message;
    setLastError(err.message);
  }
});

// ---------------- Core data loading ----------------
async function refreshAll(){
  try{
    setLastError("");

    if (!session?.access_token){
      hide(appView);
      show(loginView);
      return;
    }

    const prof = await restSelect("profiles", "*", { id: `eq.${session.user.id}` }, {});
    currentProfile = (prof && prof[0]) ? prof[0] : null;

    if (!currentProfile){
      hide(appView);
      show(loginView);
      $("loginErr").style.display = "";
      $("loginErr").textContent =
        "Signed in, but no matching profiles row exists for this user ID. Create a profiles row with id = auth.users.id.";
      return;
    }

    access = computeAccess(currentProfile);
    gateNav();
    renderSidebarHeader(currentProfile);

    const cand = await restSelect("candidates", "*", { linked_user_id: `eq.${session.user.id}` }, {});
    currentCandidate = (cand && cand[0]) ? cand[0] : null;

    // Dashboard blocks
    setText("dashFireRank", String(currentProfile.fire_level ?? "‚Äî"));
    setText("dashEmsLevel", String(currentProfile.ems_level ?? "‚Äî"));
    setText("dashStation", `Station ${String(currentProfile.station ?? "‚Äî")}`);
    setText("dashAO", `AO: ${String(currentProfile.ao_level ?? "None")}`);

    updateEmsCountdown(currentProfile);

    // Debug
    $("sessionDump").textContent = JSON.stringify({
      user_id: session.user.id,
      email: session.user.email,
      admin_role: currentProfile.admin_role,
      is_ems_instructor: currentProfile.is_ems_instructor,
      is_fire_instructor: currentProfile.is_fire_instructor,
      access
    }, null, 2);
    $("profileDump").textContent = JSON.stringify(currentProfile, null, 2);

    hide(loginView);
    show(appView);

    // Default to home
    switchPage("home");

    // Loads
    await loadWeatherForZip("76028");
    await loadMembers();
    await loadTraining();
    if (access.instructor || access.officer || access.admin) await loadQueue();
    if (access.officer || access.admin) await loadPersonnel();

  }catch(err){
    // If token expired, try refresh once
    try{
      if (session?.refresh_token){
        const s2 = await refreshToken(session.refresh_token);
        saveSession(s2);
        await refreshAll();
        return;
      }
    }catch(_){}

    setLastError(err.message);
    hide(appView);
    show(loginView);
    $("loginErr").style.display = "";
    $("loginErr").textContent = "Error loading portal:\n" + err.message;
  }
}

function updateEmsCountdown(profile){
  const raw = profile?.ems_expiration || profile?.ems_expiration_date || null;
  if (!raw){
    setText("dashEmsExpiry", "Not set");
    setText("dashEmsExpirySub", "Ask an officer/admin to add your EMS expiration date.");
    return;
  }

  const d = new Date(raw);
  if (isNaN(d.getTime())){
    setText("dashEmsExpiry", "Invalid date");
    setText("dashEmsExpirySub", "Backend date format is invalid.");
    return;
  }

  const now = new Date();
  const diffMs = d.getTime() - now.getTime();
  const diffDays = Math.floor(diffMs / (1000*60*60*24));

  if (diffDays < 0){
    setText("dashEmsExpiry", "EXPIRED");
    setText("dashEmsExpirySub", `Expired ${Math.abs(diffDays)} day(s) ago`);
    return;
  }

  const years = Math.floor(diffDays / 365);
  const remAfterYears = diffDays - years*365;
  const months = Math.floor(remAfterYears / 30);
  const days = remAfterYears - months*30;

  const parts = [];
  if (years) parts.push(`${years} year(s)`);
  if (months) parts.push(`${months} month(s)`);
  parts.push(`${days} day(s)`);

  setText("dashEmsExpiry", parts.join(" ‚Ä¢ "));
  setText("dashEmsExpirySub", `Expires on ${d.toLocaleDateString()}`);
}

// Department Personnel roster (read-only)
async function loadMembers(){
  const wrap = $("membersWrap");
  wrap.innerHTML = `<div class="hint">Loading‚Ä¶</div>`;
  try{
    const members = await restSelect(
      "profiles",
      "id,full_name,station,ems_level,fire_level,ao_level,admin_role,is_ems_instructor,is_fire_instructor",
      {},
      { order:"full_name.asc" }
    );
    $("membersCount").textContent = `${(members||[]).length}`;

    function accessLabel(m){
      const ar = String(m.admin_role ?? "None");
      const instr = (m.is_ems_instructor || m.is_fire_instructor);
      if (ar !== "None") return ar;
      if (instr) return "Instructor";
      return "Member";
    }

    wrap.innerHTML = `
      <table class="table" aria-label="Department Members">
        <thead>
          <tr>
            <th>Name</th>
            <th>Station</th>
            <th>EMS</th>
            <th>Fire</th>
            <th>AO</th>
            <th>Access</th>
          </tr>
        </thead>
        <tbody>
          ${(members||[]).map(m => `
            <tr class="row">
              <td><b>${esc(m.full_name ?? "")}</b></td>
              <td>Station ${esc(m.station ?? "")}</td>
              <td>${esc(m.ems_level ?? "")}</td>
              <td>${esc(m.fire_level ?? "")}</td>
              <td>${esc(m.ao_level ?? "")}</td>
              <td>${esc(accessLabel(m))}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }catch(err){
    wrap.innerHTML = `<div class="card"><h4>Error</h4><p>${esc(err.message)}</p></div>`;
    setLastError(err.message);
  }
}

async function loadTraining(){
  const wrap = $("trainingTableWrap");
  wrap.innerHTML = `<div class="hint">Loading‚Ä¶</div>`;
  try{
    if (!currentCandidate?.id){
      $("trainingCount").textContent = "‚Äî";
      wrap.innerHTML = `
        <div class="card">
          <h4>No linked candidate</h4>
          <p>Link your user to a candidate to view progress (<code>candidates.linked_user_id</code> = your auth user id).</p>
        </div>`;
      return;
    }

    const rows = await restSelect(
      "candidate_requirements",
      "status,updated_at,requirements(name,category,is_critical)",
      { candidate_id: `eq.${currentCandidate.id}` },
      {}
    );

    const list = rows ?? [];
    $("trainingCount").textContent = `${list.length} total`;

    wrap.innerHTML = `
      <table class="table" aria-label="Requirements">
        <thead>
          <tr>
            <th style="width:45%;">Requirement</th>
            <th style="width:20%;">Category</th>
            <th style="width:15%;">Status</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody>
          ${list.map(r => {
            const s = String(r.status || "");
            const tagClass =
              s === "Passed" ? "good" :
              s === "Retake" ? "warn" :
              s === "Failed" ? "bad" : "";
            const crit = r.requirements?.is_critical ? `<span class="badge bad">CRITICAL</span>` : "";
            return `
              <tr class="row">
                <td><b>${esc(r.requirements?.name ?? "")}</b> ${crit}</td>
                <td>${esc(r.requirements?.category ?? "")}</td>
                <td><span class="badge ${tagClass}">${esc(s || "Pending")}</span></td>
                <td style="color:var(--muted);font-size:12px;">${r.updated_at ? new Date(r.updated_at).toLocaleString() : "‚Äî"}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
  }catch(err){
    wrap.innerHTML = `<div class="card"><h4>Error</h4><p>${esc(err.message)}</p></div>`;
    setLastError(err.message);
  }
}

async function loadQueue(){
  const wrap = $("queueWrap");
  wrap.innerHTML = `<div class="panelBody"><div class="hint">Loading‚Ä¶</div></div>`;
  try{
    const cands = await restSelect("candidates", "id,full_name,station,status,created_at", {}, { order:"created_at.desc" });
    const candidates = cands ?? [];
    $("queueCount").textContent = `${candidates.length}`;

    const candIds = candidates.map(c => c.id);
    let reqRows = [];
    if (candIds.length){
      const ids = `(${candIds.join(",")})`;
      reqRows = await restSelect(
        "candidate_requirements",
        "candidate_id,status,requirements(name,is_critical,category)",
        { candidate_id: `in.${ids}` },
        {}
      );
    }

    function progressFor(id){
      const mine = (reqRows||[]).filter(r => r.candidate_id === id);
      const total = mine.length;
      const passed = mine.filter(r => r.status === "Passed").length;
      const pct = total ? Math.round((passed/total)*100) : 0;

      const needs = mine
        .filter(r => r.status !== "Passed")
        .slice(0,3)
        .map(r => {
          const cls = r.status === "Retake" ? "warn" : (r.status === "Failed" ? "bad" : "info");
          return `<span class="tag ${cls}">${esc(r.requirements?.name ?? "Need")} (${esc(r.status || "Pending")})</span>`;
        }).join("") || `<span class="tag good">No needs</span>`;

      return { total, passed, pct, needs };
    }

    wrap.innerHTML = `
      <table class="table" aria-label="Candidate Queue">
        <thead>
          <tr>
            <th style="width:26%;">Candidate</th>
            <th style="width:22%;">Progress</th>
            <th>Still needs</th>
            <th style="width:18%;">Action</th>
          </tr>
        </thead>
        <tbody>
          ${candidates.map(c => {
            const p = progressFor(c.id);
            return `
              <tr class="row">
                <td>
                  <b>${esc(c.full_name ?? "")}</b>
                  <div style="color:var(--muted); font-size:12px;">Station ${esc(c.station ?? "")} ‚Ä¢ ${esc(c.status ?? "")}</div>
                </td>
                <td>
                  <div class="progressWrap">
                    <div class="bar"><div class="fill" style="width:${p.pct}%"></div></div>
                    <div class="pct">${p.passed}/${p.total}</div>
                  </div>
                </td>
                <td><div class="needs">${p.needs}</div></td>
                <td><button class="miniBtn" data-open-eval="${c.id}" type="button">Evaluate</button></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;

    wrap.querySelectorAll("[data-open-eval]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-open-eval");
        overlayEval.classList.add("show");
        await populateEvalModal();
        $("evalCandidate").value = id;
      });
    });

  }catch(err){
    wrap.innerHTML = `<div class="panelBody"><div class="card"><h4>Error</h4><p>${esc(err.message)}</p></div></div>`;
    setLastError(err.message);
  }
}

async function loadPersonnel(){
  const wrap = $("pmWrap");
  wrap.innerHTML = `<div class="hint">Loading‚Ä¶</div>`;
  try{
    let members = null;
    try{
      members = await restSelect(
        "profiles",
        "id,full_name,station,ems_level,fire_level,ao_level,admin_role,is_ems_instructor,is_fire_instructor,ems_expiration",
        {},
        { order:"full_name.asc" }
      );
    }catch(_){
      members = await restSelect(
        "profiles",
        "id,full_name,station,ems_level,fire_level,ao_level,admin_role,is_ems_instructor,is_fire_instructor",
        {},
        { order:"full_name.asc" }
      );
    }

    $("pmCount").textContent = `${(members||[]).length}`;

    function accessLabel(m){
      const ar = String(m.admin_role ?? "None");
      const instr = (m.is_ems_instructor || m.is_fire_instructor);
      if (ar !== "None") return ar;
      if (instr) return "Instructor";
      return "Member";
    }

    wrap.innerHTML = `
      <table class="table" aria-label="Personnel">
        <thead>
          <tr>
            <th>Name</th>
            <th>Station</th>
            <th>EMS</th>
            <th>Fire</th>
            <th>AO</th>
            <th>Access</th>
            <th style="width:120px;">Action</th>
          </tr>
        </thead>
        <tbody>
          ${(members||[]).map(m => `
            <tr class="row">
              <td><b>${esc(m.full_name ?? "")}</b></td>
              <td>Station ${esc(m.station ?? "")}</td>
              <td>${esc(m.ems_level ?? "")}</td>
              <td>${esc(m.fire_level ?? "")}</td>
              <td>${esc(m.ao_level ?? "")}</td>
              <td>${esc(accessLabel(m))}</td>
              <td><button class="miniBtn" data-edit="${esc(m.id)}" type="button">Edit</button></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    wrap.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-edit");
        const member = (members||[]).find(x=>x.id===id);
        if (member) await openPersonnelModal(member);
      });
    });

  }catch(err){
    wrap.innerHTML = `<div class="card"><h4>Error</h4><p>${esc(err.message)}</p></div>`;
    setLastError(err.message);
  }
}

// ---------------- Init ----------------
async function init(){
  hide(appView);
  show(loginView);

  if (keysMissing()) {
    $("loginErr").style.display = "";
    $("loginErr").textContent = "Set SUPABASE_ANON_KEY at the top of the file, then redeploy.";
    return;
  }

  loadSession();

  if (session?.refresh_token && !session?.access_token){
    try{
      const s2 = await refreshToken(session.refresh_token);
      saveSession(s2);
    }catch(_){}
  }

  if (session?.access_token){
    try{ await refreshAll(); }catch(_){}
  }
}

init();
</script>
</body>
</html>
