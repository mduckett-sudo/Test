<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Briaroaks Department Portal</title>
  <style>
    :root{
      /* ✅ Darker overall background */
      --bg:#070709;

      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --shadow:0 18px 48px rgba(0,0,0,.55);
      --radius:18px; --radius2:14px;

      --red:#ff2b2b;
      --blue:#2b6bff;

      --good:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --info:#7aa7ff;
    }

    *{box-sizing:border-box}
    html,body{min-height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: var(--bg);
      overflow-x:hidden;
    }

    /* ✅ iOS-safe fixed background layer (solves scroll/background issues) */
    .bgLayer{
      position:fixed;
      inset:0;
      z-index:-1;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,255,255,.04), transparent 55%),
        radial-gradient(900px 600px at 75% 90%, rgba(0,0,0,.28), transparent 60%),
        /* ✅ darker grey/black gradient (less "light grey" look) */
        linear-gradient(180deg, rgba(120,120,120,.06) 0%, rgba(18,18,22,.22) 38%, rgba(0,0,0,.78) 100%),
        var(--bg);
      transform: translateZ(0);
    }

    /* Theme overrides (only used inside Training Manager) */
    body.theme-fire .bgLayer{
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(255,43,43,.16), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,43,43,.09), transparent 55%),
        radial-gradient(900px 600px at 75% 90%, rgba(255,43,43,.07), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05) 0%, rgba(16,16,20,.20) 35%, rgba(0,0,0,.78) 100%),
        var(--bg);
    }
    body.theme-ems .bgLayer{
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(43,107,255,.16), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(43,107,255,.09), transparent 55%),
        radial-gradient(900px 600px at 75% 90%, rgba(43,107,255,.07), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05) 0%, rgba(16,16,20,.20) 35%, rgba(0,0,0,.78) 100%),
        var(--bg);
    }

    button,input,select,textarea{font:inherit;color:inherit}
    a{color:inherit}

    /* Layout */
    .shell{
      display:grid;
      grid-template-columns:300px 1fr;
      min-height:100vh;
      min-height:100dvh; /* ✅ iOS dynamic toolbar safe */
    }

    .sidebar{
      position:sticky;
      top:0;
      align-self:start;
      height:100vh;
      height:100dvh; /* ✅ */
      max-height:100vh;
      max-height:100dvh;
      overflow:auto;
      -webkit-overflow-scrolling: touch; /* ✅ smoother iOS scrolling */
      padding:18px;
      border-right:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
    }

    .main{
      padding:18px 22px 36px;
      min-width:0;
    }

    /* User card */
    .userCard{
      display:flex;
      gap:12px;
      align-items:flex-start;
      padding:14px;
      border-radius:18px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    .logoWrap{
      width:46px;height:46px;border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      display:grid;place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logoWrap img{width:40px;height:40px;object-fit:contain;display:block}

    .userMeta{min-width:0}
    .userName{
      font-weight:900;
      letter-spacing:.2px;
      font-size:15px;
      line-height:1.1;
      margin:1px 0 6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .userSub{
      font-size:12px;
      color:var(--muted);
      margin:0;
      line-height:1.25;
      white-space:pre-line;
    }

    .badges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }

    .badge{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.78);
      white-space:nowrap;
    }
    .badge.fire{
      border-color:rgba(255,43,43,.35);
      background:rgba(255,43,43,.12);
      color:rgba(255,190,190,.98);
    }
    .badge.ems{
      border-color:rgba(43,107,255,.35);
      background:rgba(43,107,255,.12);
      color:rgba(190,210,255,.98);
    }

    /* Admin badge: grey fill + rainbow glowing border */
    .badge.admin{
      background:rgba(120,120,120,.20);
      color:rgba(255,255,255,.88);
      border:1px solid transparent;
      position:relative;
    }
    .badge.admin::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:999px;
      padding:1px;
      background:linear-gradient(90deg, #ff2b2b, #ffcc66, #2ee59d, #2b6bff, #b06cff, #ff2b2b);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;
              mask-composite:exclude;
      filter: drop-shadow(0 0 10px rgba(180,180,255,.28));
      pointer-events:none;
    }

    /* Status badges used in tables */
    .badge.good{border-color:rgba(46,229,157,.35);background:rgba(46,229,157,.12);color:rgba(46,229,157,.95)}
    .badge.warn{border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.12);color:rgba(255,204,102,.95)}
    .badge.bad{border-color:rgba(255,92,122,.35);background:rgba(255,92,122,.12);color:rgba(255,92,122,.95)}

    /* Nav */
    .nav{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .nav .item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid transparent;
      color:rgba(255,255,255,.68);
      cursor:pointer;
      user-select:none;
    }
    .nav .item:hover{
      background:rgba(255,255,255,.05);
      color:var(--text);
    }
    .nav .item.active{
      background:rgba(255,255,255,.10);
      border-color:rgba(255,255,255,.14);
      color:var(--text);
    }
    .nav .pill{
      margin-left:auto;
      font-size:12px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.65);
    }
    .ico{
      width:18px;height:18px; flex:0 0 auto;
      opacity:.92;
    }

    /* Topbar */
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:14px;
      border-radius:var(--radius);
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);
      flex-wrap:wrap;
    }
    .search{
      flex:1;
      min-width:220px;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
    }
    .search input{width:100%; border:0; outline:0; background:transparent; font-size:14px}
    .search input::placeholder{color:rgba(255,255,255,.42)}
    .rightTools{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    .btn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.045);
      color:var(--text);
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      gap:10px;
      align-items:center;
      transition:transform .06s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{background:rgba(255,255,255,.07); border-color:rgba(255,255,255,.18)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border-color:rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
    }
    .btn.danger{
      border-color:rgba(255,92,122,.34);
      background:rgba(255,92,122,.12);
    }
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px}
    .btn.ghost{background:transparent}

    /* Pages + panels */
    .pageHead{
      margin:18px 4px 14px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .pageHead h2{margin:0; font-size:18px; letter-spacing:.2px}
    .pageHead p{margin:6px 0 0 0; font-size:13px; color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

    /* ✅ Dashboard tiles: stable responsive grid + true titles */
    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(190px, 1fr));
      gap:12px;
      margin:14px 0 12px;
    }
    .stat{
      padding:14px;
      border-radius:var(--radius);
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 14px 38px rgba(0,0,0,.22);
      min-height:108px;
      overflow:hidden;
      min-width:0; /* ✅ prevents iOS grid overflow */
    }
    .stat .t{
      font-size:13px;
      font-weight:900;
      letter-spacing:.2px;
      margin-bottom:10px;
      color:rgba(255,255,255,.88);
    }
    .stat .v{
      margin-top:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:.2px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stat .sub{
      margin-top:10px;
      color:rgba(255,255,255,.58);
      font-size:12px;
      line-height:1.35;
      white-space:pre-line;
    }

    .panel{
      border-radius:var(--radius);
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 18px 48px rgba(0,0,0,.22);
      overflow:hidden;
      margin-top:12px;
    }
    .panelHead{
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      flex-wrap:wrap;
    }
    .panelHead h3{margin:0; font-size:13px; letter-spacing:.25px}
    .panelHead .small{font-size:12px; color:var(--muted)}
    .panelBody{padding:14px}

    .card{
      padding:12px;
      border-radius:var(--radius2);
      background:rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      margin-bottom:10px;
    }
    .card h4{margin:0; font-size:13px; letter-spacing:.2px}
    .card p{margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.45}

    .table{width:100%; border-collapse:collapse}
    .table th,.table td{
      text-align:left; padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:13px; vertical-align:top;
    }
    .table th{
      font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.25px;
      background:rgba(0,0,0,.12);
    }
    .row:hover td{background:rgba(255,255,255,.04)}

    .miniBtn{
      padding:7px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      color:var(--text);
      font-size:12px;
    }
    .miniBtn:hover{background:rgba(255,255,255,.07)}

    /* Login */
    .center{min-height:100vh; min-height:100dvh; display:grid; place-items:center; padding:22px}
    .loginCard{
      width:min(560px, 100%);
      padding:18px;
      border-radius:22px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 30px 90px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
    }
    .field{display:flex; flex-direction:column; gap:6px; margin-top:10px}
    .field label{font-size:12px; color:var(--muted)}
    .field input,.field select,.field textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:10px;
      outline:none;
      font-size:13px;
    }
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .err{margin-top:10px; color:rgba(255,92,122,.95); font-size:12px; white-space:pre-wrap}
    .ok{margin-top:10px; color:rgba(46,229,157,.95); font-size:12px; white-space:pre-wrap}

    /* Modal */
    .overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:18px; z-index:50}
    .overlay.show{display:flex}
    .modal{
      width:min(980px, 100%);
      border-radius:22px;
      background:rgba(15,15,18,.82);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 30px 90px rgba(0,0,0,.6);
      backdrop-filter: blur(16px);
      overflow:hidden;
    }
    .modalHead{
      display:flex; justify-content:space-between; gap:10px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      align-items:center;
      flex-wrap:wrap;
    }
    .modalHead h3{margin:0; font-size:14px}
    .modalBody{display:grid; grid-template-columns:1fr 360px; min-height:380px}
    .rubric{padding:16px; border-right:1px solid rgba(255,255,255,.10)}
    .sideForm{padding:16px; display:flex; flex-direction:column; gap:12px}
    textarea{min-height:120px; resize:vertical}

    /* Training Manager toggle */
    .segWrap{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .seg{
      display:flex;
      gap:6px;
      padding:6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
    }
    .seg button{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      color:rgba(255,255,255,.72);
      font-size:12px;
    }
    .seg button.active{
      background:rgba(255,255,255,.10);
      border-color:rgba(255,255,255,.16);
      color:rgba(255,255,255,.92);
    }
    .segHint{font-size:12px; color:var(--muted)}

    @media (max-width: 1100px){
      /* stats auto-fit handles most cases; keeping this is fine */
    }
    @media (max-width: 980px){
      .shell{grid-template-columns:1fr}
      .sidebar{position:relative; height:auto; max-height:none}
      .modalBody{grid-template-columns:1fr}
      .rubric{border-right:0; border-bottom:1px solid rgba(255,255,255,.10)}
    }
    @media (max-width: 520px){
      .search{width:100%}
      .rightTools{width:100%; justify-content:space-between}
    }
  </style>
</head>

<body class="theme-default">
  <div class="bgLayer" aria-hidden="true"></div>

  <!-- LOGIN -->
  <section id="loginView" class="center">
    <noscript>
      <div style="max-width:560px;margin:12px auto 0 auto;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,204,102,.35);background:rgba(255,204,102,.10);color:rgba(255,204,102,.95);font-size:12px;line-height:1.45;">
        JavaScript is disabled or blocked. This portal requires JavaScript.
      </div>
    </noscript>

    <div class="loginCard">
      <div style="display:flex;gap:12px;align-items:center;">
        <div class="logoWrap" aria-hidden="true">
          <img src="./logo.png" alt="Briaroaks logo" onerror="this.style.display='none'">
        </div>
        <div>
          <div style="font-weight:900; letter-spacing:.2px; font-size:16px;">Briaroaks Department Portal</div>
          <div class="hint">No external JS CDN • Supabase via fetch()</div>
        </div>
        <span class="badge" style="margin-left:auto;">iPad-friendly</span>
      </div>

      <div class="card" style="margin-top:14px;">
        <h4>Sign in</h4>
        <p>Uses Supabase Auth REST + PostgREST. If you can sign in here, the full portal will work anywhere—even on restricted networks.</p>
      </div>

      <form id="loginForm">
        <div class="field">
          <label>Email</label>
          <input id="email" type="email" placeholder="you@department.org" required />
        </div>
        <div class="field">
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••" required />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
          <button class="btn primary" type="submit">Sign in</button>
          <button class="btn" type="button" id="signUpBtn">Create account</button>
          <button class="btn ghost" type="button" id="clearSessionBtn" title="Clears local session storage">Clear session</button>
        </div>

        <div id="loginErr" class="err" style="display:none;"></div>
        <div id="loginOk" class="ok" style="display:none;"></div>

        <div class="hint" style="margin-top:10px;">
          Tip: You can also create users in Supabase → Authentication → Users.
        </div>
      </form>
    </div>
  </section>

  <!-- APP -->
  <section id="appView" style="display:none;">
    <div class="shell">
      <aside class="sidebar">
        <!-- User card -->
        <div class="userCard">
          <div class="logoWrap" aria-hidden="true">
            <img src="./logo.png" alt="Briaroaks logo" onerror="this.style.display='none'">
          </div>
          <div class="userMeta">
            <div class="userName" id="sideName">Loading…</div>
            <p class="userSub" id="sideSub">—</p>
            <div class="badges" id="sideBadges"></div>
          </div>
        </div>

        <!-- Nav -->
        <nav class="nav" id="nav">
          <div class="item active" data-page="home">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1V10.5Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
            <span>Dashboard Home</span><span class="pill">Home</span>
          </div>

          <div class="item" data-page="training">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M7 4h10a2 2 0 0 1 2 2v14H7a2 2 0 0 0-2 2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M7 18h12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            <span>My Training</span><span class="pill">My</span>
          </div>

          <div class="item" data-page="department">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M16 11a4 4 0 1 0-8 0 4 4 0 0 0 8 0Z" stroke="currentColor" stroke-width="1.6"/><path d="M4 21a8 8 0 0 1 16 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            <span>Department Personnel</span>
          </div>

          <div class="item" data-page="trainingManager" data-staff="instructor">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h10M4 17h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/><path d="M16 11.5 20 9v6l-4-2.5Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
            <span>Training Manager</span><span class="pill">Staff</span>
          </div>

          <div class="item" data-page="personnel" data-staff="admin">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M12 2 4 6v6c0 5 3.6 9.4 8 10 4.4-.6 8-5 8-10V6l-8-4Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/><path d="M9.5 12.5 11 14l3.5-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span>Personnel Manager</span><span class="pill">Admin</span>
          </div>

          <div class="item" data-page="settings">
            <svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.6"/><path d="M19.4 15a7.8 7.8 0 0 0 .1-2l2-1.2-2-3.4-2.3.6a7.3 7.3 0 0 0-1.7-1l-.3-2.3H10.8l-.3 2.3a7.3 7.3 0 0 0-1.7 1L6.5 8.4l-2 3.4 2 1.2a7.8 7.8 0 0 0 .1 2l-2 1.2 2 3.4 2.3-.6a7.3 7.3 0 0 0 1.7 1l.3 2.3h4.4l.3-2.3a7.3 7.3 0 0 0 1.7-1l2.3.6 2-3.4-2-1.2Z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg>
            <span>Settings</span>
          </div>
        </nav>
      </aside>

      <main class="main">
        <div class="topbar">
          <div class="search" role="search">
            <svg class="ico" style="width:16px;height:16px;opacity:.75" viewBox="0 0 24 24" fill="none"><path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6"/><path d="M16.3 16.3 21 21" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
            <input placeholder="Search (visual only) …" />
          </div>

          <div class="rightTools">
            <button class="btn" id="refreshBtn">Refresh</button>
            <button class="btn danger" id="logoutBtn">Log out</button>
          </div>
        </div>

        <!-- DASHBOARD -->
        <section id="page-home">
          <div class="pageHead">
            <div>
              <h2>Dashboard Home</h2>
              <p>Quick snapshot: Weather • Fire Rank • EMS Level • AO Status • Station • Expiration.</p>
            </div>
            <div class="actions">
              <button class="btn primary" id="goTrainingBtn">Open My Training</button>
            </div>
          </div>

          <!-- ✅ Updated tiles: true bold titles, no pills -->
          <div class="stats">
            <div class="stat">
              <div class="t">Weather</div>
              <div class="v" id="dashWeather">Loading…</div>
              <div class="sub" id="dashWeatherSub">—</div>
            </div>

            <div class="stat">
              <div class="t">Fire Rank</div>
              <div class="v" id="dashFireRank">—</div>
              <div class="sub" id="dashFireRankSub">—</div>
            </div>

            <div class="stat">
              <div class="t">EMS Level</div>
              <div class="v" id="dashEmsLevel">—</div>
              <div class="sub" id="dashEmsLevelSub">—</div>
            </div>

            <div class="stat">
              <div class="t">AO Status</div>
              <div class="v" id="dashAO">—</div>
              <div class="sub" id="dashAOSub">—</div>
            </div>

            <div class="stat">
              <div class="t">Station Assignment</div>
              <div class="v" id="dashStation">—</div>
              <div class="sub" id="dashStationSub">—</div>
            </div>

            <div class="stat">
              <div class="t">EMS Expiration</div>
              <div class="v" id="dashEmsExpiry">—</div>
              <div class="sub" id="dashEmsExpirySub">—</div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>What’s next</h3>
                <div class="small">Your requirements and progress live under “My Training”.</div>
              </div>
              <button class="btn small" id="dashTrainingTile">Go</button>
            </div>
            <div class="panelBody">
              <div class="card">
                <h4>Keep it simple</h4>
                <p>Dashboard stays lightweight so it loads fast on iPads and station Wi-Fi.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- MY TRAINING -->
        <section id="page-training" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>My Training</h2>
              <p>Your requirements, progress, and status updates.</p>
            </div>
            <div class="actions">
              <button class="btn" id="refreshTrainingBtn">Refresh</button>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Requirements</h3>
                <div class="small">From <code>candidate_requirements</code> joined to <code>requirements</code>.</div>
              </div>
              <span class="badge" id="trainingCount">—</span>
            </div>
            <div class="panelBody" id="trainingTableWrap"></div>
          </div>
        </section>

        <!-- DEPARTMENT PERSONNEL (all can see) -->
        <section id="page-department" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>Department Personnel</h2>
              <p>All members: name • station • EMS • Fire • AO.</p>
            </div>
            <div class="actions">
              <button class="btn" id="refreshDeptBtn">Refresh</button>
              <span class="badge" id="deptCount">—</span>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Members</h3>
                <div class="small">Read-only directory.</div>
              </div>
            </div>
            <div class="panelBody" id="deptWrap"></div>
          </div>
        </section>

        <!-- TRAINING MANAGER -->
        <section id="page-trainingManager" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>Training Manager</h2>
              <p>Staff view. Choose Fire or EMS training for this page.</p>
            </div>
            <div class="actions segWrap">
              <div class="seg" aria-label="Training track toggle">
                <button id="tmFireBtn" type="button" class="active">Fire Training</button>
                <button id="tmEmsBtn" type="button">EMS Training</button>
              </div>
              <span class="segHint" id="tmModeHint">Theme: Fire</span>
              <button class="btn" id="refreshTMBtn">Refresh</button>
              <button class="btn primary" id="openEvalBtn">Start Evaluation</button>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Candidate Queue</h3>
                <div class="small">Shows candidates your account is allowed to see (RLS).</div>
              </div>
              <span class="badge" id="queueCount">—</span>
            </div>
            <div id="queueWrap"></div>
          </div>
        </section>

        <!-- PERSONNEL MANAGER (admin only) -->
        <section id="page-personnel" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>Personnel Manager</h2>
              <p>Admin can manage member assignments and instructor flags.</p>
            </div>
            <div class="actions">
              <button class="btn" id="refreshPMBtn">Refresh</button>
              <span class="badge" id="pmCount">—</span>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div>
                <h3>Members</h3>
                <div class="small">Edit station, levels, AO, EMS expiration, instructor flags, admin_role.</div>
              </div>
            </div>
            <div class="panelBody" id="pmWrap"></div>
          </div>
        </section>

        <!-- SETTINGS / DEBUG -->
        <section id="page-settings" style="display:none;">
          <div class="pageHead">
            <div>
              <h2>Settings</h2>
              <p>Debug session + profile.</p>
            </div>
          </div>
          <div class="panel">
            <div class="panelHead">
              <h3>Debug</h3>
              <span class="badge">Useful</span>
            </div>
            <div class="panelBody">
              <div class="card">
                <h4>Session</h4>
                <pre id="sessionDump" style="white-space:pre-wrap;margin:0;color:rgba(255,255,255,.78);font-size:12px;"></pre>
              </div>
              <div class="card">
                <h4>Profile (raw)</h4>
                <pre id="profileDump" style="white-space:pre-wrap;margin:0;color:rgba(255,255,255,.78);font-size:12px;"></pre>
              </div>
              <div class="card">
                <h4>Last error</h4>
                <pre id="lastErrorDump" style="white-space:pre-wrap;margin:0;color:rgba(255,255,255,.78);font-size:12px;"></pre>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </section>

  <!-- EVALUATION MODAL -->
  <div id="overlayEval" class="overlay" role="dialog" aria-modal="true" aria-label="Evaluation Modal">
    <div class="modal">
      <div class="modalHead">
        <h3>Submit Evaluation</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="badge">Writes to DB</span>
          <button class="btn" id="closeEvalBtn">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="rubric">
          <div class="card">
            <h4>How this works</h4>
            <p>
              On submit, we create a row in <code>evaluations</code> and update the matching row in
              <code>candidate_requirements</code>.
            </p>
          </div>
          <div class="card">
            <h4>Rubric (placeholder)</h4>
            <p>Later we can build real rubrics per skill station.</p>
          </div>
        </div>

        <div class="sideForm">
          <div class="field">
            <label>Candidate</label>
            <select id="evalCandidate"></select>
          </div>

          <div class="field">
            <label>Requirement</label>
            <select id="evalRequirement"></select>
          </div>

          <div class="field">
            <label>Result (req_status)</label>
            <select id="evalResult">
              <option value="Passed">Passed</option>
              <option value="Retake">Retake</option>
              <option value="Failed">Failed</option>
            </select>
          </div>

          <div class="field">
            <label>Critical Fail</label>
            <select id="evalCritical">
              <option value="false">No</option>
              <option value="true">Yes — Critical Fail</option>
            </select>
          </div>

          <div class="field">
            <label>Notes</label>
            <textarea id="evalNotes" placeholder="Remediation notes / strengths / follow-up."></textarea>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="submitEvalBtn">Submit</button>
          </div>

          <div id="evalErr" class="err" style="display:none;"></div>
          <div id="evalOk" class="ok" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PERSONNEL MODAL -->
  <div id="overlayPM" class="overlay" role="dialog" aria-modal="true" aria-label="Personnel Modal">
    <div class="modal">
      <div class="modalHead">
        <h3>Edit Member</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="badge">Updates profiles</span>
          <button class="btn" id="closePMBtn">Close</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="rubric">
          <div class="card">
            <h4>Editing rules</h4>
            <p>Admin can edit station/levels/AO + EMS expiration + instructor flags + admin_role.</p>
          </div>
          <div class="card">
            <h4>Selected member</h4>
            <p id="pmSelected">—</p>
            <div style="margin-top:10px;">
              <span class="badge" id="pmIdTag">ID: —</span>
            </div>
          </div>
        </div>

        <div class="sideForm">
          <div class="field">
            <label>Station (station enum)</label>
            <select id="pmStation">
              <option value="173">Station 173</option>
              <option value="273">Station 273</option>
            </select>
          </div>

          <div class="field">
            <label>EMS Level (ems_level enum)</label>
            <select id="pmEms"></select>
          </div>

          <div class="field">
            <label>Fire Level (fire_level enum)</label>
            <select id="pmFire"></select>
          </div>

          <div class="field">
            <label>AO Level (ao_level enum)</label>
            <select id="pmAO"></select>
          </div>

          <div class="field">
            <label>EMS Expiration (optional column: ems_expiration)</label>
            <input id="pmEmsExp" type="date" />
            <div class="hint">If your profiles table doesn’t have <code>ems_expiration</code>, this will be ignored safely.</div>
          </div>

          <div class="card">
            <h4>Access</h4>
            <p>Instructor flags control Training Manager access. Admin role controls admin access.</p>
          </div>

          <div class="field">
            <label>Fire Instructor</label>
            <select id="pmFireInstr">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>

          <div class="field">
            <label>EMS Instructor</label>
            <select id="pmEmsInstr">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>

          <div class="field">
            <label>Admin Role (admin_role enum)</label>
            <select id="pmAdminRole">
              <option value="None">None</option>
              <option value="Admin">Admin</option>
              <option value="Fire Chief">Fire Chief</option>
            </select>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="savePMBtn">Save</button>
          </div>

          <div id="pmErr" class="err" style="display:none;"></div>
          <div id="pmOk" class="ok" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/***********************************************************************
 * ✅ SET THESE TWO VALUES (Supabase → Project Settings → API)
 **********************************************************************/
const SUPABASE_URL = "https://xjaihdmbblieyzkltvmm.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqYWloZG1iYmxpZXl6a2x0dm1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyOTY3MzcsImV4cCI6MjA4Njg3MjczN30.eR8C_ororBpLxSXfuLM8Q6fKvKQnCVRcZnNEH2pM4jA";
/**********************************************************************/

// ---------------- Helpers ----------------
const $ = (id) => document.getElementById(id);
const show = (el) => el.style.display = "";
const hide = (el) => el.style.display = "none";
const setText = (id, text) => { const el = $(id); if (el) el.textContent = text; };
const esc = (s)=> (s??"").toString()
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

function keysMissing() {
  return !SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("PASTE_");
}

function setLastError(msg){
  console.log("ERROR:", msg);
  $("lastErrorDump").textContent = String(msg ?? "");
}

function setTheme(theme){ // "default" | "fire" | "ems"
  document.body.classList.remove("theme-default","theme-fire","theme-ems");
  document.body.classList.add("theme-" + theme);
}

// ---------------- Supabase REST (no CDN) ----------------
const AUTH_URL = () => `${SUPABASE_URL}/auth/v1`;
const REST_URL = () => `${SUPABASE_URL}/rest/v1`;

function baseHeaders(){
  return {
    "apikey": SUPABASE_ANON_KEY,
    "Content-Type": "application/json",
  };
}

function authHeaders(){
  const access = session?.access_token;
  return access
    ? { ...baseHeaders(), "Authorization": `Bearer ${access}` }
    : baseHeaders();
}

async function fetchJson(url, options={}){
  const res = await fetch(url, options);
  const text = await res.text();
  let json = null;
  try { json = text ? JSON.parse(text) : null; } catch { json = null; }
  if (!res.ok) {
    const msg = json?.msg || json?.message || text || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return json;
}

async function signIn(email, password){
  const url = `${AUTH_URL()}/token?grant_type=password`;
  return await fetchJson(url, {
    method:"POST",
    headers: { ...baseHeaders(), "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
    body: JSON.stringify({ email, password })
  });
}

async function signUp(email, password){
  const url = `${AUTH_URL()}/signup`;
  return await fetchJson(url, {
    method:"POST",
    headers: { ...baseHeaders(), "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
    body: JSON.stringify({ email, password })
  });
}

async function refreshToken(refresh_token){
  const url = `${AUTH_URL()}/token?grant_type=refresh_token`;
  return await fetchJson(url, {
    method:"POST",
    headers: { ...baseHeaders(), "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
    body: JSON.stringify({ refresh_token })
  });
}

async function signOut(){
  clearSession();
}

async function restSelect(table, select, filters={}, opts={}){
  const query = new URLSearchParams();
  query.set("select", select);
  Object.entries(filters).forEach(([k,v])=>{
    if (v===undefined || v===null || v==="") return;
    query.set(k, v);
  });
  if (opts.order) query.set("order", opts.order);
  if (opts.limit) query.set("limit", String(opts.limit));

  const url = `${REST_URL()}/${table}?${query.toString()}`;
  return await fetchJson(url, { headers: authHeaders() });
}

async function restInsert(table, rows){
  const url = `${REST_URL()}/${table}`;
  return await fetchJson(url, {
    method:"POST",
    headers: { ...authHeaders(), "Prefer":"return=representation" },
    body: JSON.stringify(rows)
  });
}

async function restPatch(table, patchObj, filters){
  const query = new URLSearchParams();
  Object.entries(filters||{}).forEach(([k,v])=> query.set(k, v));
  const url = `${REST_URL()}/${table}?${query.toString()}`;
  return await fetchJson(url, {
    method:"PATCH",
    headers: { ...authHeaders(), "Prefer":"return=representation" },
    body: JSON.stringify(patchObj)
  });
}

// ---------------- State ----------------
let session = null;     // { access_token, refresh_token, user }
let currentProfile = null;
let currentCandidate = null;

let access = { admin:false, instructor:false, emsInstr:false, fireInstr:false };
let trainingMode = "fire"; // fire | ems (only for Training Manager page)

// ---------------- Pages ----------------
const loginView = $("loginView");
const appView = $("appView");

const pages = ["home","training","department","trainingManager","personnel","settings"];
const navItems = Array.from(document.querySelectorAll("#nav .item"));

function switchPage(page){
  navItems.forEach(i => i.classList.toggle("active", i.dataset.page === page));
  pages.forEach(p => {
    const el = document.getElementById("page-" + p);
    if (el) el.style.display = (p === page) ? "" : "none";
  });

  // ✅ Theme behavior:
  // - Default theme everywhere
  // - Training Manager theme depends on mode (fire/ems)
  if (page === "trainingManager"){
    setTheme(trainingMode === "ems" ? "ems" : "fire");
  } else {
    setTheme("default");
  }

  window.scrollTo({ top: 0, behavior: "smooth" });
}

navItems.forEach(item => item.addEventListener("click", () => {
  const page = item.dataset.page;
  switchPage(page);
}));

function computeAccess(profile){
  const adminRole = String(profile?.admin_role ?? "").trim();
  const admin = (adminRole === "Admin" || adminRole === "Fire Chief");

  const fireInstr = !!profile?.is_fire_instructor || admin;
  const emsInstr  = !!profile?.is_ems_instructor  || admin;
  const instructor = fireInstr || emsInstr;

  return { admin, instructor, emsInstr, fireInstr };
}

function gateNav(){
  const tm = navItems.find(x => x.dataset.page === "trainingManager");
  const pm = navItems.find(x => x.dataset.page === "personnel");

  if (tm) tm.style.display = access.instructor ? "" : "none";
  if (pm) pm.style.display = access.admin ? "" : "none";
}

// ---------------- Training Manager mode toggle ----------------
const tmFireBtn = $("tmFireBtn");
const tmEmsBtn = $("tmEmsBtn");
const tmModeHint = $("tmModeHint");

function setTrainingMode(mode){
  trainingMode = mode === "ems" ? "ems" : "fire";
  tmFireBtn.classList.toggle("active", trainingMode === "fire");
  tmEmsBtn.classList.toggle("active", trainingMode === "ems");
  tmModeHint.textContent = "Theme: " + (trainingMode === "ems" ? "EMS" : "Fire");

  // Only apply theme if we are currently on trainingManager page
  const isOnTM = document.getElementById("page-trainingManager").style.display !== "none";
  if (isOnTM){
    setTheme(trainingMode === "ems" ? "ems" : "fire");
  }
}

tmFireBtn.addEventListener("click", () => setTrainingMode("fire"));
tmEmsBtn.addEventListener("click", () => setTrainingMode("ems"));

// ---------------- Session persistence ----------------
const SESSION_KEY = "briaroaks_portal_session_v2";

function saveSession(s){
  session = s;
  localStorage.setItem(SESSION_KEY, JSON.stringify(s));
}

function loadSession(){
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    session = raw ? JSON.parse(raw) : null;
  } catch {
    session = null;
  }
  return session;
}

function clearSession(){
  session = null;
  localStorage.removeItem(SESSION_KEY);
}

$("clearSessionBtn").addEventListener("click", () => {
  clearSession();
  $("loginOk").style.display = "";
  $("loginOk").textContent = "Session cleared. You can sign in fresh now.";
});

// ---------------- UI actions ----------------
$("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  $("loginErr").style.display = "none";
  $("loginOk").style.display = "none";
  setLastError("");

  if (keysMissing()) {
    $("loginErr").style.display = "";
    $("loginErr").textContent = "Missing key: set SUPABASE_ANON_KEY at the top of the file.";
    return;
  }

  const email = $("email").value.trim();
  const password = $("password").value;

  try{
    const s = await signIn(email, password);
    saveSession(s);
    $("loginOk").style.display = "";
    $("loginOk").textContent = "Signed in. Loading portal…";
    await refreshAll();
  }catch(err){
    $("loginErr").style.display = "";
    $("loginErr").textContent = err.message;
    setLastError(err.message);
  }
});

$("signUpBtn").addEventListener("click", async () => {
  $("loginErr").style.display = "none";
  $("loginOk").style.display = "none";
  setLastError("");

  if (keysMissing()) {
    $("loginErr").style.display = "";
    $("loginErr").textContent = "Missing key: set SUPABASE_ANON_KEY at the top of the file.";
    return;
  }

  const email = $("email").value.trim();
  const password = $("password").value;

  try{
    await signUp(email, password);
    $("loginOk").style.display = "";
    $("loginOk").textContent = "Account created. If confirmation is enabled, check your email. Otherwise sign in now.";
  }catch(err){
    $("loginErr").style.display = "";
    $("loginErr").textContent = err.message;
    setLastError(err.message);
  }
});

$("logoutBtn").addEventListener("click", async () => {
  await signOut();
  currentProfile = null;
  currentCandidate = null;
  hide(appView);
  show(loginView);
  setTheme("default");
});

$("refreshBtn").addEventListener("click", refreshAll);
$("refreshTrainingBtn").addEventListener("click", loadTraining);
$("refreshDeptBtn").addEventListener("click", loadDepartment);
$("refreshTMBtn").addEventListener("click", loadQueue);
$("refreshPMBtn").addEventListener("click", loadPersonnel);

$("goTrainingBtn").addEventListener("click", () => switchPage("training"));
$("dashTrainingTile").addEventListener("click", () => switchPage("training"));

// ---------------- Evaluation modal ----------------
const overlayEval = $("overlayEval");
$("closeEvalBtn").addEventListener("click", () => overlayEval.classList.remove("show"));
overlayEval.addEventListener("click", (e) => { if (e.target === overlayEval) overlayEval.classList.remove("show"); });

$("openEvalBtn").addEventListener("click", async () => {
  $("evalErr").style.display = "none";
  $("evalOk").style.display = "none";
  overlayEval.classList.add("show");
  await populateEvalModal();
});

$("submitEvalBtn").addEventListener("click", async () => {
  $("evalErr").style.display = "none";
  $("evalOk").style.display = "none";
  setLastError("");

  const candidateId = $("evalCandidate").value;
  const requirementId = $("evalRequirement").value;
  const result = $("evalResult").value;
  const criticalFail = $("evalCritical").value === "true";
  const notes = $("evalNotes").value;

  if (!candidateId || !requirementId) {
    $("evalErr").style.display = "";
    $("evalErr").textContent = "Choose a candidate and a requirement.";
    return;
  }

  try{
    await restInsert("evaluations", [{
      candidate_id: candidateId,
      requirement_id: requirementId,
      evaluator_id: session.user.id,
      result,
      critical_fail: criticalFail,
      notes
    }]);

    await restPatch("candidate_requirements",
      { status: result, updated_at: new Date().toISOString() },
      { candidate_id: `eq.${candidateId}`, requirement_id: `eq.${requirementId}` }
    );

    $("evalOk").style.display = "";
    $("evalOk").textContent = "Saved. Requirement updated to: " + result;
    await refreshAll();
  }catch(err){
    $("evalErr").style.display = "";
    $("evalErr").textContent = err.message;
    setLastError(err.message);
  }
});

async function populateEvalModal(){
  try{
    const cands = await restSelect("candidates", "id,full_name,station,status,created_at", {}, { order:"created_at.desc" });
    const candSel = $("evalCandidate");
    candSel.innerHTML = "";
    (cands||[]).forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = `${c.full_name} • Station ${c.station ?? ""} • ${c.status ?? ""}`;
      candSel.appendChild(opt);
    });

    const reqs = await restSelect("requirements", "id,name,category,is_critical,created_at", {}, { order:"created_at.desc" });
    const reqSel = $("evalRequirement");
    reqSel.innerHTML = "";
    (reqs||[]).forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.id;
      opt.textContent = `${r.name} • ${r.category ?? ""}${r.is_critical ? " • CRITICAL" : ""}`;
      reqSel.appendChild(opt);
    });

    if (currentCandidate?.id) candSel.value = currentCandidate.id;
  }catch(err){
    $("evalErr").style.display = "";
    $("evalErr").textContent = err.message;
    setLastError(err.message);
  }
}

// ---------------- Personnel modal ----------------
const overlayPM = $("overlayPM");
$("closePMBtn").addEventListener("click", () => overlayPM.classList.remove("show"));
overlayPM.addEventListener("click", (e) => { if (e.target === overlayPM) overlayPM.classList.remove("show"); });

const EMS_LEVELS = ["None","ECA","EMT-B","Paramedic"];
const AO_LEVELS  = ["None","AO-EMS","AO-1","AO-2"];
const FIRE_LEVELS = ["None","Level 5","Level 4","Level 3","Level 2","Level 1","Lieutenant","Captain","Deputy Chief","Assistant Chief","Fire Chief"];

function fillSelect(id, values){
  const sel = $(id);
  sel.innerHTML = "";
  values.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}
fillSelect("pmEms", EMS_LEVELS);
fillSelect("pmAO", AO_LEVELS);
fillSelect("pmFire", FIRE_LEVELS);

let editingMember = null;

async function openPersonnelModal(member){
  editingMember = member;
  $("pmErr").style.display = "none";
  $("pmOk").style.display = "none";
  setLastError("");

  $("pmSelected").textContent = `${member.full_name ?? "—"}`;
  $("pmIdTag").textContent = `ID: ${member.id}`;

  $("pmStation").value = String(member.station ?? "173");
  $("pmEms").value = String(member.ems_level ?? "None");
  $("pmFire").value = String(member.fire_level ?? "None");
  $("pmAO").value = String(member.ao_level ?? "None");

  const exp = member.ems_expiration ? String(member.ems_expiration).slice(0,10) : "";
  $("pmEmsExp").value = exp;

  $("pmFireInstr").value = String(!!member.is_fire_instructor);
  $("pmEmsInstr").value  = String(!!member.is_ems_instructor);
  $("pmAdminRole").value = String(member.admin_role ?? "None");

  overlayPM.classList.add("show");
}

$("savePMBtn").addEventListener("click", async () => {
  $("pmErr").style.display = "none";
  $("pmOk").style.display = "none";
  setLastError("");

  if (!editingMember?.id){
    $("pmErr").style.display = "";
    $("pmErr").textContent = "No member selected.";
    return;
  }

  const patch = {
    station: $("pmStation").value,
    ems_level: $("pmEms").value,
    fire_level: $("pmFire").value,
    ao_level: $("pmAO").value,
    is_fire_instructor: $("pmFireInstr").value === "true",
    is_ems_instructor: $("pmEmsInstr").value === "true",
    admin_role: $("pmAdminRole").value
  };

  const exp = $("pmEmsExp").value;
  patch.ems_expiration = exp ? exp : null;

  try{
    await restPatch("profiles", patch, { id: `eq.${editingMember.id}` });
    $("pmOk").style.display = "";
    $("pmOk").textContent = "Saved.";
    await refreshAll();
    await loadPersonnel();
  }catch(err){
    $("pmErr").style.display = "";
    $("pmErr").textContent = err.message;
    setLastError(err.message);
  }
});

// ---------------- Weather (76028) ----------------
async function loadWeather76028(){
  // 76028 ≈ Burleson, TX (lat/lon)
  const lat = 32.542;
  const lon = -97.320;

  try{
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=America%2FChicago`;
    const data = await fetchJson(url, { method:"GET" });

    const temp = Math.round(data?.current?.temperature_2m ?? NaN);
    const wind = Math.round(data?.current?.wind_speed_10m ?? NaN);
    const code = data?.current?.weather_code;

    const desc = weatherCodeToText(code);

    // ✅ Weather tile format: big temp only, details below
    setText("dashWeather", `${isFinite(temp) ? temp + "°F" : "—"}`);
    setText("dashWeatherSub", `${desc} • Wind ${isFinite(wind) ? wind : "—"} mph`);
  }catch(err){
    setText("dashWeather", "—");
    setText("dashWeatherSub", "Weather unavailable");
  }
}

function weatherCodeToText(code){
  const c = Number(code);
  if (!isFinite(c)) return "—";
  if (c === 0) return "Clear";
  if (c === 1 || c === 2) return "Partly cloudy";
  if (c === 3) return "Overcast";
  if (c === 45 || c === 48) return "Fog";
  if ([51,53,55].includes(c)) return "Drizzle";
  if ([61,63,65].includes(c)) return "Rain";
  if ([71,73,75].includes(c)) return "Snow";
  if ([80,81,82].includes(c)) return "Showers";
  if ([95,96,99].includes(c)) return "Thunderstorm";
  return "Weather";
}

// ---------------- Core data loading ----------------
async function refreshAll(){
  try{
    setLastError("");
    if (!session?.access_token){
      hide(appView);
      show(loginView);
      return;
    }

    // Profiles row MUST exist with id = auth user id
    const prof = await restSelect("profiles", "*", { id: `eq.${session.user.id}` }, {});
    currentProfile = (prof && prof[0]) ? prof[0] : null;

    if (!currentProfile){
      hide(appView);
      show(loginView);
      $("loginErr").style.display = "";
      $("loginErr").textContent =
        "Signed in, but no matching profiles row exists for this user ID. Create a profiles row with id = auth.users.id.";
      return;
    }

    access = computeAccess(currentProfile);
    gateNav();

    const cand = await restSelect("candidates", "*", { linked_user_id: `eq.${session.user.id}` }, {});
    currentCandidate = (cand && cand[0]) ? cand[0] : null;

    // Sidebar user card
    setText("sideName", currentProfile.full_name ?? "User");

    const ems = String(currentProfile.ems_level ?? "—");
    const fire = String(currentProfile.fire_level ?? "—");
    setText("sideSub", `${ems} - ${fire}`);

    const badges = [];
    if (access.fireInstr) badges.push(`<span class="badge fire">Fire Instructor</span>`);
    if (access.emsInstr)  badges.push(`<span class="badge ems">EMS Instructor</span>`);
    if (access.admin)     badges.push(`<span class="badge admin">Admin</span>`);
    $("sideBadges").innerHTML = badges.join("");

    // ✅ Dashboard tiles (new layout)
    setText("dashFireRank", fire);
    setText("dashFireRankSub", "Current rank");

    setText("dashEmsLevel", ems);
    setText("dashEmsLevelSub", "Current level");

    setText("dashAO", String(currentProfile.ao_level ?? "None"));
    setText("dashAOSub", "Current status");

    setText("dashStation", `Station ${String(currentProfile.station ?? "—")}`);
    setText("dashStationSub", "Assigned station");

    updateEmsCountdown(currentProfile);
    await loadWeather76028();

    // Debug
    $("sessionDump").textContent = JSON.stringify({
      user_id: session.user.id,
      email: session.user.email,
      admin_role: currentProfile.admin_role,
      is_fire_instructor: currentProfile.is_fire_instructor,
      is_ems_instructor: currentProfile.is_ems_instructor,
      access
    }, null, 2);
    $("profileDump").textContent = JSON.stringify(currentProfile, null, 2);

    hide(loginView);
    show(appView);

    await loadTraining();
    await loadDepartment();
    if (access.instructor) await loadQueue();
    if (access.admin) await loadPersonnel();

    // If user is currently on Training Manager, keep TM theme; otherwise default
    const tmVisible = document.getElementById("page-trainingManager").style.display !== "none";
    if (tmVisible) setTheme(trainingMode === "ems" ? "ems" : "fire");
    else setTheme("default");

    // Default landing
    switchPage("home");
  }catch(err){
    try{
      if (session?.refresh_token){
        const s2 = await refreshToken(session.refresh_token);
        saveSession(s2);
        await refreshAll();
        return;
      }
    }catch(_){}

    setLastError(err.message);
    hide(appView);
    show(loginView);
    $("loginErr").style.display = "";
    $("loginErr").textContent = "Error loading portal:\n" + err.message;
  }
}

function updateEmsCountdown(profile){
  const raw = profile?.ems_expiration || profile?.ems_expiration_date || null;
  if (!raw){
    setText("dashEmsExpiry", "Not set");
    setText("dashEmsExpirySub", "Ask an officer/admin to add your EMS expiration date.");
    return;
  }

  const d = new Date(raw);
  if (isNaN(d.getTime())){
    setText("dashEmsExpiry", "Invalid date");
    setText("dashEmsExpirySub", "Backend date format is invalid.");
    return;
  }

  const now = new Date();
  const diffMs = d.getTime() - now.getTime();
  const diffDays = Math.floor(diffMs / (1000*60*60*24));

  // ✅ Tile shows DATE as main line; countdown/expired status as sub
  if (diffDays < 0){
    setText("dashEmsExpiry", d.toLocaleDateString());
    setText("dashEmsExpirySub", `EXPIRED • ${Math.abs(diffDays)} day(s) ago`);
    return;
  }

  const years = Math.floor(diffDays / 365);
  const remAfterYears = diffDays - years*365;
  const months = Math.floor(remAfterYears / 30);
  const days = remAfterYears - months*30;

  const parts = [];
  if (years) parts.push(`${years} year(s)`);
  if (months) parts.push(`${months} month(s)`);
  parts.push(`${days} day(s)`);

  setText("dashEmsExpiry", d.toLocaleDateString());
  setText("dashEmsExpirySub", parts.join(" • "));
}

// ---------------- My Training ----------------
async function loadTraining(){
  const wrap = $("trainingTableWrap");
  wrap.innerHTML = `<div class="hint">Loading…</div>`;
  try{
    if (!currentCandidate?.id){
      $("trainingCount").textContent = "—";
      wrap.innerHTML = `
        <div class="card">
          <h4>No linked candidate</h4>
          <p>Link your user to a candidate to view progress (<code>candidates.linked_user_id</code> = your auth user id).</p>
        </div>`;
      return;
    }

    const rows = await restSelect(
      "candidate_requirements",
      "status,updated_at,requirements(name,category,is_critical)",
      { candidate_id: `eq.${currentCandidate.id}` },
      {}
    );

    const list = rows ?? [];
    $("trainingCount").textContent = `${list.length} total`;

    wrap.innerHTML = `
      <table class="table" aria-label="Requirements">
        <thead>
          <tr>
            <th style="width:45%;">Requirement</th>
            <th style="width:20%;">Category</th>
            <th style="width:15%;">Status</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody>
          ${list.map(r => {
            const s = String(r.status || "");
            const tagClass =
              s === "Passed" ? "good" :
              s === "Retake" ? "warn" :
              s === "Failed" ? "bad" : "";
            const crit = r.requirements?.is_critical ? `<span class="badge bad">CRITICAL</span>` : "";
            return `
              <tr class="row">
                <td><b>${esc(r.requirements?.name ?? "")}</b> ${crit}</td>
                <td>${esc(r.requirements?.category ?? "")}</td>
                <td><span class="badge ${tagClass}">${esc(s || "Pending")}</span></td>
                <td style="color:rgba(255,255,255,.60);font-size:12px;">${r.updated_at ? new Date(r.updated_at).toLocaleString() : "—"}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
  }catch(err){
    wrap.innerHTML = `<div class="card"><h4>Error</h4><p>${esc(err.message)}</p></div>`;
    setLastError(err.message);
  }
}

// ---------------- Department Personnel (read-only) ----------------
async function loadDepartment(){
  const wrap = $("deptWrap");
  wrap.innerHTML = `<div class="hint">Loading…</div>`;
  try{
    const members = await restSelect(
      "profiles",
      "id,full_name,station,ems_level,fire_level,ao_level",
      {},
      { order:"full_name.asc" }
    );
    $("deptCount").textContent = `${(members||[]).length}`;

    wrap.innerHTML = `
      <table class="table" aria-label="Department Personnel">
        <thead>
          <tr>
            <th>Name</th>
            <th>Station</th>
            <th>EMS</th>
            <th>Fire</th>
            <th>AO</th>
          </tr>
        </thead>
        <tbody>
          ${(members||[]).map(m => `
            <tr class="row">
              <td><b>${esc(m.full_name ?? "")}</b></td>
              <td>Station ${esc(m.station ?? "")}</td>
              <td>${esc(m.ems_level ?? "")}</td>
              <td>${esc(m.fire_level ?? "")}</td>
              <td>${esc(m.ao_level ?? "")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }catch(err){
    wrap.innerHTML = `<div class="card"><h4>Error</h4><p>${esc(err.message)}</p></div>`;
    setLastError(err.message);
  }
}

// ---------------- Training Manager ----------------
async function loadQueue(){
  const wrap = $("queueWrap");
  wrap.innerHTML = `<div class="panelBody"><div class="hint">Loading…</div></div>`;
  try{
    const cands = await restSelect("candidates", "id,full_name,station,status,created_at", {}, { order:"created_at.desc" });
    const candidates = cands ?? [];
    $("queueCount").textContent = `${candidates.length}`;

    const candIds = candidates.map(c => c.id);
    let reqRows = [];
    if (candIds.length){
      const ids = `(${candIds.join(",")})`;
      reqRows = await restSelect(
        "candidate_requirements",
        "candidate_id,status,requirements(name,is_critical,category)",
        { candidate_id: `in.${ids}` },
        {}
      );
    }

    function progressFor(id){
      const mine = (reqRows||[]).filter(r => r.candidate_id === id);
      const total = mine.length;
      const passed = mine.filter(r => r.status === "Passed").length;
      const pct = total ? Math.round((passed/total)*100) : 0;
      return { total, passed, pct };
    }

    wrap.innerHTML = `
      <div class="panelBody">
        <table class="table" aria-label="Candidate Queue">
          <thead>
            <tr>
              <th style="width:34%;">Candidate</th>
              <th style="width:18%;">Progress</th>
              <th style="width:22%;">Status</th>
              <th style="width:18%;">Action</th>
            </tr>
          </thead>
          <tbody>
            ${candidates.map(c => {
              const p = progressFor(c.id);
              return `
                <tr class="row">
                  <td>
                    <b>${esc(c.full_name ?? "")}</b>
                    <div style="color:rgba(255,255,255,.60); font-size:12px;">Station ${esc(c.station ?? "")}</div>
                  </td>
                  <td>${p.passed}/${p.total} (${p.pct}%)</td>
                  <td>${esc(c.status ?? "")}</td>
                  <td><button class="miniBtn" data-open-eval="${c.id}">Evaluate</button></td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>
    `;

    wrap.querySelectorAll("[data-open-eval]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-open-eval");
        overlayEval.classList.add("show");
        await populateEvalModal();
        $("evalCandidate").value = id;
      });
    });

  }catch(err){
    wrap.innerHTML = `<div class="panelBody"><div class="card"><h4>Error</h4><p>${esc(err.message)}</p></div></div>`;
    setLastError(err.message);
  }
}

// ---------------- Personnel Manager (admin only) ----------------
async function loadPersonnel(){
  const wrap = $("pmWrap");
  wrap.innerHTML = `<div class="hint">Loading…</div>`;
  try{
    let members = null;
    try{
      members = await restSelect(
        "profiles",
        "id,full_name,station,ems_level,fire_level,ao_level,admin_role,is_fire_instructor,is_ems_instructor,ems_expiration",
        {},
        { order:"full_name.asc" }
      );
    }catch(_){
      members = await restSelect(
        "profiles",
        "id,full_name,station,ems_level,fire_level,ao_level,admin_role,is_fire_instructor,is_ems_instructor",
        {},
        { order:"full_name.asc" }
      );
    }

    $("pmCount").textContent = `${(members||[]).length}`;

    wrap.innerHTML = `
      <table class="table" aria-label="Personnel Manager">
        <thead>
          <tr>
            <th>Name</th>
            <th>Station</th>
            <th>EMS</th>
            <th>Fire</th>
            <th>AO</th>
            <th>Access</th>
            <th style="width:120px;">Action</th>
          </tr>
        </thead>
        <tbody>
          ${(members||[]).map(m => {
            const acc = [];
            if (m.is_fire_instructor) acc.push("Fire Instr");
            if (m.is_ems_instructor) acc.push("EMS Instr");
            if (m.admin_role && m.admin_role !== "None") acc.push(m.admin_role);
            return `
              <tr class="row">
                <td><b>${esc(m.full_name ?? "")}</b></td>
                <td>Station ${esc(m.station ?? "")}</td>
                <td>${esc(m.ems_level ?? "")}</td>
                <td>${esc(m.fire_level ?? "")}</td>
                <td>${esc(m.ao_level ?? "")}</td>
                <td>${esc(acc.join(" • ") || "—")}</td>
                <td><button class="miniBtn" data-edit="${esc(m.id)}">Edit</button></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;

    wrap.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-edit");
        const member = (members||[]).find(x=>x.id===id);
        if (member) await openPersonnelModal(member);
      });
    });

  }catch(err){
    wrap.innerHTML = `<div class="card"><h4>Error</h4><p>${esc(err.message)}</p></div>`;
    setLastError(err.message);
  }
}

// ---------------- Init ----------------
async function init(){
  hide(appView);
  show(loginView);
  setTheme("default");

  if (keysMissing()) {
    $("loginErr").style.display = "";
    $("loginErr").textContent = "Set SUPABASE_ANON_KEY at the top of the file, then redeploy.";
    return;
  }

  loadSession();

  if (session?.refresh_token && !session?.access_token){
    try{
      const s2 = await refreshToken(session.refresh_token);
      saveSession(s2);
    }catch(_){}
  }

  if (session?.access_token){
    try{ await refreshAll(); }catch(_){}
  }

  // Default TM mode
  setTrainingMode("fire");
}

init();
</script>
</body>
</html>
